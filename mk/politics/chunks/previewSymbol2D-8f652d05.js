import{i8 as e,x as t,i9 as a,ia as l,bf as n,e as i,ib as s,ic as o,id as u,ie as c,bc as m}from"../main.js";const r="picture-fill",h=e.size,d=e.maxSize,p=e.maxOutlineSize,f=e.lineWidth,v=document.createElement("canvas");function y(e,t){const a=v.getContext("2d"),l=[];return t&&(t.weight&&l.push(t.weight),t.size&&l.push(t.size+"px"),t.family&&l.push(t.family)),a.font=l.join(" "),a.measureText(e).width}function w(e){if(0===e.length)return 0;if(e.length>2){const t=m(1),a=parseFloat(e);switch(e.slice(-2)){case"px":return a;case"pt":return a*t;case"in":return 72*a*t;case"pc":return 12*a*t;case"mm":return 2.8346456692913384*a*t;case"cm":return 28.346456692913385*a*t}}return parseFloat(e)}function b(e){const a=null==e?void 0:e.size;return{width:null!=a&&"object"==typeof a&&"width"in a?t(a.width):null,height:null!=a&&"object"==typeof a&&"height"in a?t(a.height):null}}function g(e,m){var v,g;const M="number"==typeof(null==m?void 0:m.size)?null==m?void 0:m.size:null,x=null!=M?t(M):null,k=null!=(null==m?void 0:m.maxSize)?t(m.maxSize):null,L=null!=(null==m?void 0:m.opacity)?m.opacity:null,z=null!=(null==m?void 0:m.rotation)?m.rotation:"angle"in e?e.angle:null,S=a(e);let j=l(e);if(S&&!j){const e="type"in S?null:new n(S);"#ffffff"===(e?e.toHex():null)&&(j={color:"#bdc3c7",width:.75})}const C={shape:null,fill:null,stroke:j,offset:[0,0]};null!=(v=j)&&v.width&&(j.width=Math.min(j.width,p));const F=(null==(g=j)?void 0:g.width)||0;let P=null!=(null==m?void 0:m.size)&&(null==(null==m?void 0:m.scale)||(null==m?void 0:m.scale)),Z=0,q=0,E=!1;switch(e.type){case"simple-marker":{const a=e.style,l=Math.min(null!=x?x:t(e.size),k||d);switch(Z=l,q=l,a){case"circle":C.shape={type:"circle",cx:0,cy:0,r:.5*l},P||(Z+=F,q+=F);break;case"cross":C.shape={type:"path",path:[{command:"M",values:[0,.5*q]},{command:"L",values:[Z,.5*q]},{command:"M",values:[.5*Z,0]},{command:"L",values:[.5*Z,q]}]};break;case"diamond":C.shape={type:"path",path:[{command:"M",values:[0,.5*q]},{command:"L",values:[.5*Z,0]},{command:"L",values:[Z,.5*q]},{command:"L",values:[.5*Z,q]},{command:"Z",values:[]}]},P||(Z+=F,q+=F);break;case"square":C.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[Z,0]},{command:"L",values:[Z,q]},{command:"L",values:[0,q]},{command:"Z",values:[]}]},P||(Z+=F,q+=F),z&&(E=!0);break;case"triangle":C.shape={type:"path",path:[{command:"M",values:[.5*Z,0]},{command:"L",values:[Z,q]},{command:"L",values:[0,q]},{command:"Z",values:[]}]},P||(Z+=F,q+=F),z&&(E=!0);break;case"x":C.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[Z,q]},{command:"M",values:[Z,0]},{command:"L",values:[0,q]}]},z&&(E=!0);break;case"path":C.shape={type:"path",path:e.path||""},P||(Z+=F,q+=F),z&&(E=!0),P=!0}break}case"simple-line":{var D;const{width:e,height:t}=b(m),a=null!=t?t:Math.min(null!=x?x:F,k||p),l=null!=e?e:f;j.width=a,Z=l,q=a;const n=(null==C||null==(D=C.stroke)?void 0:D.cap)||"butt",i="round"===n;P=!0,C.stroke.cap="butt"===n?"square":n,C.shape={type:"path",path:[{command:"M",values:[i?a/2:0,q/2]},{command:"L",values:[i?Z-a/2:Z,q/2]}]};break}case r:case"simple-fill":{const e="object"==typeof(null==m?void 0:m.symbolConfig)&&(null==m?void 0:m.symbolConfig.isSquareFill),{width:t,height:a}=b(m);Z=e&&null!=t?t:null!=x?x:h,q=e&&null!=a?a:Z,P||(Z+=F,q+=F),P=!0,C.shape=e?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[Z,0]},{command:"L",values:[Z,q]},{command:"L",values:[0,q]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:c.fill[0];break}case"picture-marker":{let a=t(e.width),l=t(e.height);const n=null!=x?x:Math.max(a,l),i=a/l;a=i<=1?Math.ceil(n*i):n,l=i<=1?n:Math.ceil(n/i),Z=Math.min(a,k||d),q=Math.min(l,k||d),C.shape={type:"image",x:-Math.round(Z/2),y:-Math.round(q/2),width:Z,height:q,src:e.url||""},z&&(E=!0);break}case"text":{const a=e,l=a.text||"Aa",n=a.font,i=Math.min(null!=x?x:t(n.size),k||d),s=y(l,{weight:n.weight,size:i,family:n.family}),o=/[\uE600-\uE6FF]/.test(l);Z=o?i:s,q=i;let u=.25*w((n?i:0).toString());o&&(u+=5),C.shape={type:"text",text:l,x:0,y:u,align:"middle",decoration:n&&n.decoration,rotated:a.rotated,kerning:a.kerning},C.font=n&&{size:i,style:n.style,decoration:n.decoration,weight:n.weight,family:n.family};break}}if(!C.shape)return Promise.reject(new i("symbolPreview: renderPreviewHTML2D","symbol not supported."));const H=S,T=e.color;let V=null;return H&&"pattern"===H.type&&T&&e.type!==r?V=s(H.src,T.toCss(!0)).then((e=>(H.src=e,C.fill=H,C))):(C.fill=S,V=Promise.resolve(C)),V.then((e=>{const t=[[e]];if("object"==typeof(null==m?void 0:m.symbolConfig)&&null!=m&&m.symbolConfig.applyColorModulation){const a=.6*Z;t.unshift([{...e,offset:[-a,0],fill:o(S,-.3)}]),t.push([{...e,offset:[a,0],fill:o(S,.3)}]),Z+=2*a,P=!1}return u(t,[Z,q],{node:m&&m.node,scale:P,opacity:L,rotation:z,useRotationSize:E,effectView:null==m?void 0:m.effectView})}))}export{g as previewSymbol2D};
