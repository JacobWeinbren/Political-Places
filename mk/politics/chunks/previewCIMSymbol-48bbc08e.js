import{aC as e,k as t,c9 as a,C as i,bt as r,x as s,ig as n,bf as o,c7 as c,ih as l,ii as m,au as h,av as f,i8 as u,ij as y,ik as g,id as d,bc as p}from"../main.js";import{H as M,o as C}from"./cimAnalyzer-7a366be2.js";import{e as I,s as z}from"./CIMSymbolHelper-cbb4397a.js";import{m as w}from"./Rasterizer-5fa7b7dd.js";import"./enums-7acaa04d.js";import"./quantizationUtils-6ec6d37f.js";import"./BidiEngine-07ac28a3.js";import"./alignmentUtils-3fedcae3.js";import"./number-b530ed41.js";import"./GeometryUtils-fb44f136.js";var x;!function(e){e.Legend="legend",e.Preview="preview"}(x||(x={}));const P=(e,t,a)=>{if(e&&e.targetSize){let i;if(a){const t=Math.max(a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin);i=e.targetSize/s(t)}else i=e.targetSize/t.referenceSize;return i}return e&&e.scaleFactor?e.scaleFactor:1},b={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};function _(e,t,a,i){let r,s;return"function"==typeof e.materialHash?(r=(0,e.materialHash)(t,a,i),s=C(e.cim,e.materialOverrides)):(r=e.materialHash,s=e.cim),{analyzedCIM:s,hash:r}}const v=new class{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new I,this._cimResourceManager=new z,this._rasterizer=new w(this._cimResourceManager)}async rasterizeCIMSymbolAsync(t,a,i,r,s,n,o,c){r=r||(a?null!=a.centroid?"esriGeometryPolygon":e(a.geometry):null)||function(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}(t);const l=await this.analyzeCIMSymbol(t,a?function(e){return(e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}(a.attributes):null,i,r,c);return this.rasterizeCIMSymbol(l,a,r,s,n,o)}async analyzeCIMSymbol(e,i,r,s,n){const o=[],c=i?{geometryType:s,spatialReference:this._spatialReference,fields:i}:null;let l;await M(e.data,c,this._cimResourceManager,o,this._avoidSDF),t(n);for(const e of o)"CIMPictureMarker"!==e.cim.type&&"CIMPictureFill"!==e.cim.type&&"CIMPictureStroke"!==e.cim.type||(l||(l=[]),l.push(this._fetchPictureMarkerResource(e,n))),r&&"text"===e.type&&"string"==typeof e.text&&e.text.indexOf("[")>-1&&(e.text=a(r,e.text,e.cim.textCase));return l&&await Promise.all(l),o}async _fetchPictureMarkerResource(e,t){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const r=(await i(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(a,r)}}rasterizeCIMSymbol(e,t,a,i,s,n){const o=[];for(const c of e){i&&"function"==typeof i.scaleFactor&&(i.scaleFactor=i.scaleFactor(t,s,n));const e=this._getRasterizedResource(c,t,a,i,s,n);if(!e)continue;let l=0,m=e.anchorX||0,h=e.anchorY||0,f=!1,u=0,y=0;if("esriGeometryPoint"===a){const e=P(i,c,null);if(u=r(c.offsetX,t,s,n)*e||0,y=r(c.offsetY,t,s,n)*e||0,"marker"===c.type)l=r(c.rotation,t,s,n)||0,f=!!c.rotateClockwise&&c.rotateClockwise;else if("text"===c.type){if(l=r(c.angle,t,s,n)||0,void 0!==c.horizontalAlignment)switch(c.horizontalAlignment){case"left":m=-.5;break;case"right":m=.5;break;default:m=0}if(void 0!==c.verticalAlignment)switch(c.verticalAlignment){case"top":h=.5;break;case"bottom":h=-.5;break;case"baseline":h=-.25;break;default:h=0}}}null!=e&&o.push({angle:l,rotateClockWise:f,anchorX:m,anchorY:h,offsetX:u,offsetY:y,rasterizedResource:e})}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement("canvas"),a=t.getContext("2d");let i=0,r=0,o=0,c=0;const l=[];for(let t=0;t<e.length;t++){const n=e[t],m=n.rasterizedResource;if(!m)continue;const h=m.size,f=n.offsetX,u=n.offsetY,y=n.anchorX,g=n.anchorY,d=n.rotateClockWise||!1;let p=n.angle,M=s(f)-h[0]*(.5+y),C=s(u)-h[1]*(.5+g),I=M+h[0],z=C+h[1];if(p){d&&(p=-p);const e=Math.sin(p*Math.PI/180),t=Math.cos(p*Math.PI/180),a=M*t-C*e,i=M*e+C*t,r=M*t-z*e,s=M*e+z*t,n=I*t-z*e,o=I*e+z*t,c=I*t-C*e,l=I*e+C*t;M=Math.min(a,r,n,c),C=Math.min(i,s,o,l),I=Math.max(a,r,n,c),z=Math.max(i,s,o,l)}i=M<i?M:i,r=C<r?C:r,o=I>o?I:o,c=z>c?z:c;const w=a.createImageData(m.size[0],m.size[1]);w.data.set(new Uint8ClampedArray(m.image.buffer));const x={offsetX:f,offsetY:u,rotateClockwise:d,angle:p,rasterizedImage:w,anchorX:y,anchorY:g};l.push(x)}t.width=o-i,t.height=c-r;const m=-i,h=c;for(let e=0;e<l.length;e++){const t=l[e],i=this._imageDataToCanvas(t.rasterizedImage),r=t.rasterizedImage.width,n=t.rasterizedImage.height,o=m-r*(.5+t.anchorX),c=h-n*(.5-t.anchorY);if(t.angle){const e=(360-t.angle)*Math.PI/180;a.save(),a.translate(s(t.offsetX),-s(t.offsetY)),a.translate(m,h),a.rotate(e),a.translate(-m,-h),a.drawImage(i,o,c),a.restore()}else a.drawImage(i,o+s(t.offsetX),c-s(t.offsetY))}const f=new n({x:m/t.width-.5,y:h/t.height-.5});return{imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:f}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,a=t.getContext("2d");return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t}_imageTo32Array(e,t,a,i){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const r=this._imageDataCanvas,s=r.getContext("2d");if(r.width=t,r.height=a,s.drawImage(e,0,0,t,a),i){s.save();const r=new o(i);s.fillStyle=r.toHex(),s.globalCompositeOperation="multiply",s.fillRect(0,0,t,a),s.globalCompositeOperation="destination-atop",s.drawImage(e,0,0,t,a),s.restore()}return new Uint32Array(s.getImageData(0,0,t,a).data.buffer)}_getRasterizedResource(e,t,a,i,s,n){let o,m,h,f,u=null,y=null;if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a){const l=i&&i.style?i.style:x.Legend,f="esriGeometryPolyline"===a?b.stroke[l]:b.fill[l];if("line"===e.type){if("CIMSolidStroke"!==e.cim.type){if("CIMPictureStroke"===e.cim.type){const a=r(e.width,t,s,n),i=r(e.color,t,s,n),{image:o,width:c,height:l}=this._getPictureResource(e,a,i);return this._rasterizePictureResource(e,o,c,l,f,a)}return null}({analyzedCIM:o,hash:h}=_(e,t,s,n)),m=this._embedCIMLayerInVectorMarker(o,f)}else if("marker"===e.type){if("CIMPictureMarker"===e.cim.type){const a=r(e.size,t,s,n),i=r(e.color,t,s,n),{image:o,width:c,height:l}=this._getPictureResource(e,a,i);return this._rasterizePictureResource(e,o,c,l,f,a)}if("CIMVectorMarker"!==e.cim.type)return null;e.cim.offsetX=r(e.offsetX,t,s,n),e.cim.offsetY=r(e.offsetY,t,s,n),e.cim.rotation=r(e.rotation,t,s,n),e.cim.markerPlacement=e.markerPlacement,({analyzedCIM:o}=_(e,t,s,n)),h=c(JSON.stringify(o)).toString(),m=this._embedCIMLayerInVectorMarker(o,f),u=r(e.size,t,s,n),y=e.path}else{if("text"===e.type)return null;if("fill"===e.type){if("CIMHatchFill"===e.cim.type||"CIMVectorMarker"===e.cim.type||"CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type){const a=e.cim.size||e.cim.height;let i,c,l;if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type)({image:i,width:c,height:l}=this._getPictureResource(e,a,r(e.color,t,s,n)));else{({analyzedCIM:o,hash:h}=_(e,t,s,n));const r=this._rasterizer.rasterizeJSONResource({cim:o,type:e.type,url:e.url,mosaicHash:h,size:a,path:y},1,this._avoidSDF);i=r.image,c=r.size[0],l=r.size[1]}return this._rasterizePictureResource(e,i,c,l,f,null)}if("CIMSolidFill"!==e.cim.type)return null;({analyzedCIM:o,hash:h}=_(e,t,s,n)),m=this._embedCIMLayerInVectorMarker(o,f)}}}else{if("text"===e.type)return f=this._rasterizeTextResource(e,t,i,s,n),f;({analyzedCIM:o,hash:h}=_(e,t,s,n));const a=P(i,e,null);if("CIMPictureMarker"===e.cim.type){const i=r(e.size,t,s,n)*a,{image:o,width:c,height:l}=this._getPictureResource(e,i,r(e.color,t,s,n));return f={image:o,size:[c,l],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},f}l(o,a,{preserveOutlineWidth:!1}),m=o}h+=a,i&&(h+=JSON.stringify(i));const g=this._resourceCache;return g.has(h)?g.get(h):(f=this._rasterizer.rasterizeJSONResource({cim:m,type:e.type,url:e.url,mosaicHash:h,size:u,path:y},window.devicePixelRatio||1,this._avoidSDF),g.set(h,f),f)}_rasterizeTextResource(e,t,a,i,s){const n=P(a,e,null),o=r(e.text,t,i,s);if(!o||0===o.length)return null;const c=r(e.fontName,t,i,s),l=r(e.style,t,i,s),h=r(e.weight,t,i,s),f=r(e.decoration,t,i,s),u=r(e.size,t,i,s)*n,y=r(e.horizontalAlignment,t,i,s),g=r(e.verticalAlignment,t,i,s),d=m(r(e.color,t,i,s)),p=m(r(e.outlineColor,t,i,s)),M={color:d,size:u,horizontalAlignment:y,verticalAlignment:g,font:{family:c,style:l,weight:h,decoration:f},halo:{size:r(e.outlineSize,t,i,s)||0,color:p,style:l},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,M)}_rasterizePictureResource(e,t,a,i,r,n){const o=document.createElement("canvas"),c=o.getContext("2d");o.height=s(Math.max(r.frame.ymax-r.frame.ymin,n)),o.width=s(r.frame.xmax-r.frame.xmin);const l=c.createImageData(a,i);l.data.set(new Uint8ClampedArray(t.buffer));const m=this._imageDataToCanvas(l),u=c.createPattern(m,"repeat"),y=Math.cos((-e.cim.rotation||0)*Math.PI/180),g=Math.sin((-e.cim.rotation||0)*Math.PI/180);u.setTransform({m11:y,m12:g,m21:-g,m22:y,m41:s(e.cim.offsetX)||0,m42:s(e.cim.offsetY)||0});const d=r.canvasPaths;let p,M,C;h(d)?(p=d.rings,c.fillStyle=u,M=c.fill,C=["evenodd"]):f(d)&&(p=d.paths,c.strokeStyle=u,c.lineWidth=n,M=c.stroke,p[0][0][1]=o.height/2,p[0][1][1]=o.height/2),c.beginPath();for(const e of p){const t=e?e.length:0;if(t>1){let a=e[0];c.moveTo(s(a[0]),s(a[1]));for(let i=1;i<t;++i)a=e[i],c.lineTo(s(a[0]),s(a[1]));c.closePath()}}M.apply(c,C);const I=c.getImageData(0,0,o.width,o.height),z=new Uint8Array(I.data);return{size:[o.width,o.height],image:new Uint32Array(z.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,a){const i=this._pictureMarkerCache.get(e.materialHash);if(!i)return null;const r=i.height/i.width,n=t?r>1?s(t):s(t)/r:i.width,o=t?r>1?s(t)*r:s(t):i.height;return{image:this._imageTo32Array(i,n,o,a),width:n,height:o}}_embedCIMLayerInVectorMarker(e,t){const a=h(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",i=t.frame;return{type:"CIMVectorMarker",frame:i,size:i.ymax-i.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:a,symbolLayers:[e]}}]}}}(null,!0),k=u.maxSize;async function S(e,t={}){const{size:a,maxSize:i,node:r,opacity:s}=t,n=t.cimOptions||t,{feature:o,fieldMap:c,geometryType:l,style:m}=n,h=y(e),f="number"==typeof a?a:null,u=Math.min(null!=f?f:h,null!=i?i:p(k));u!==h&&(e=e.clone(),g(e,u,{preserveOutlineWidth:!0}));let M=3;e&&e.data&&e.data.symbol&&"CIMPointSymbol"!==e.data.symbol.type&&(M=1);const C=await v.rasterizeCIMSymbolAsync(e,o,c,l,{scaleFactor:M,style:m}),I=document.createElement("canvas");I.width=C.imageData.width,I.height=C.imageData.height,I.getContext("2d").putImageData(C.imageData,0,0);let z=I.width/M,w=I.height/M;if(null!=a&&(null==(null==t?void 0:t.scale)||(null==t?void 0:t.scale))){const e=z/w;z=e<=1?Math.ceil(u*e):u,w=e<=1?u:Math.ceil(u/e)}const x=new Image(z,w);x.src=I.toDataURL(),null!=s&&(x.style.opacity=`${s}`);let P=x;if(null!=t.effectView){const e={shape:{type:"image",x:0,y:0,width:z,height:w,src:x.src},fill:null,stroke:null,offset:[0,0]};P=d([[e]],[z,w],{effectView:t.effectView})}return r&&r.appendChild(P),P}export{S as previewCIMSymbol};
