import{dr as e,ds as n,cp as t,cC as i,t as s,r as o,c3 as r,a8 as a,dt as l,e as c,du as f,dv as u,dw as x,dx as h,dy as m,aT as p,dz as g}from"../main.js";function y(e,n,t){return!l(e,n,t)}function d(n,t,i){const s=y(n,t,i);if(s&&!e())throw new c("rasterprojectionhelper-project","projection engine is not loaded");return s}const M=function(e,n,t,i=0){if(1===t[0])return[0,0];let s=1,o=-1,r=1,a=-1;for(let n=0;n<e.length;n+=2)isNaN(e[n])||(s=s>e[n]?e[n]:s,o=o>e[n]?o:e[n],r=r>e[n+1]?e[n+1]:r,a=a>e[n+1]?a:e[n+1]);const{cols:l,rows:c}=n,f=(o-s)/l/t[0],u=(a-r)/c/t[1],x=2*i;let h=0,m=!1,p=[0,0];for(let n=0;n<l-3;n++){for(let t=0;t<c-3;t++){const i=n*c*2+2*t,s=(e[i]+e[i+4]+e[i+4*c]+e[i+4*c+4])/4,o=(e[i+1]+e[i+5]+e[i+4*c+1]+e[i+4*c+5])/4,r=Math.abs((s-e[i+2*c+2])/f),a=Math.abs((o-e[i+2*c+3])/u);if(r+a>h&&(h=r+a,p=[r,a]),x&&h>x){m=!0;break}}if(m)break}return p},w={3395:20037508.342789244,3410:17334193.943686873,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53034:20015086.79602057,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54034:20037508.342789244,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244},R=new Map,P=new Map;async function S(){if(e())return null;await n()}function b(e,n,t){return d(e.spatialReference,n)?t?g(n,e.spatialReference,e):g(e.spatialReference,n,e):null}function G(e,n,a,l=null){const c=e.spatialReference;if(c.equals(n))return e;d(c,n,l);const f=a.center,u=new t({xmin:f.x-e.x/2,xmax:f.x+e.x/2,ymin:f.y-e.y/2,ymax:f.y+e.y/2,spatialReference:c}),x=i(u,n,l);if(s(x))return null;const h={x:x.xmax-x.xmin,y:x.ymax-x.ymin},m=j(n);if(o(m)&&h.x>=m){const t=r(c)/r(n);h.x=e.x*t,h.y=e.y*t}return h}function E(e,n=.01){return r(e)?n/r(e):0}function k(e,n,t=null,s=!0){const r=e.spatialReference;if(r.equals(n))return e;d(r,n,t);const a=i(e,n,t);if(!s||!a)return a;const l=A(r,!0),c=A(n,!0),f=E(r);return f&&o(l)&&o(c)&&(a.x>0&&Math.abs(e.x-l[0])<f?a.x-=c[1]-c[0]:a.x<0&&Math.abs(e.x-l[1])<f&&(a.x+=c[1]-c[0])),a}function N(e){const{inSR:n,outSR:t,datumTransformation:s,preferPE:r}=e;if(n.equals(t)){const{points:n}=_(e,null);return n}if(n.isWebMercator&&t.isWGS84||n.isWGS84&&t.isWebMercator)return function(e){const{cols:n,rows:t,xres:s,yres:o,usePixelCenter:r,inSR:l,outSR:c}=e;let{xmin:f,ymax:u}=e;r&&(f+=s/2,u-=o/2);const x=[],h=[],m=Math.max(n,t);for(let e=0;e<m;e++){const r=f+s*Math.min(n,e),m=u-o*Math.min(t,e),p=i(new a({x:r,y:m,spatialReference:l}),c);e<=n&&x.push(p.x),e<=t&&h.push(p.y)}const p=[];for(let e=0;e<n;e++)for(let n=0;n<t;n++)p.push([x[e],h[n]]);return p}(e);if(d(n,t,s)&&r){if(n.isGeographic)return v(e);const t=T(n);if(o(t))return v(e)}return function(e){const{points:n}=_(e,null),t=n.map((n=>new a(n[0],n[1],e.inSR)));return i(t,e.outSR,e.datumTransformation).map((e=>e?[e.x,e.y]:[NaN,NaN]))}(e)}function v(e){const{inSR:n,outSR:t,datumTransformation:i}=e,s=T(n),{points:r,mask:a}=_(e,s);if(!n.isGeographic){const e=n.wkid?f.coordsys(n.wkid):f.fromString(n.isGeographic?u.PE_TYPE_GEOGCS:u.PE_TYPE_PROJCS,n.wkt);x.projToGeog(e,r.length,r)}if(o(i)&&i.steps.length&&i.steps.forEach((e=>{const n=e.wkid?f.geogtran(e.wkid):f.fromString(u.PE_TYPE_GEOGTRAN,e.wkt);h.geogToGeog(n,r.length,r,null,e.isInverse?u.PE_TRANSFORM_2_TO_1:u.PE_TRANSFORM_1_TO_2)})),!t.isGeographic){const e=T(t,!0),n=o(e)&&e.isEnvelope?[e.bbox[1],e.bbox[3]]:[-90,90];!function(e,n){const[t,i]=n;for(let n=0;n<e.length;n++){const s=e[n][1];(s<t||s>i)&&(e[n]=[NaN,NaN])}}(r,n);const i=t.wkid?f.coordsys(t.wkid):f.fromString(t.isGeographic?u.PE_TYPE_GEOGCS:u.PE_TYPE_PROJCS,t.wkt);x.geogToProj(i,r.length,r)}let l=r;if(a&&r.length!==a.length){l=[];for(let e=0,n=0;e<a.length;e++)a[e]?l.push(r[n++]):l.push([NaN,NaN])}return l}function T(e,n=!1){let t=e.wkid||e.wkt;if(!t||e.isGeographic)return null;if(t=String(t),R.has(t)){const e=R.get(t);return n?null==e?void 0:e.gcs:null==e?void 0:e.pcs}const i=e.wkid?f.coordsys(e.wkid):f.fromString(e.isGeographic?u.PE_TYPE_GEOGCS:u.PE_TYPE_PROJCS,e.wkt),s=C(i,E(e,1e-4)),o=C(i,0,!0);return R.set(t,{pcs:s,gcs:o}),n?o:s}function C(e,n=0,t=!1){const i=m.generate(e),s=t?e.horizonGcsGenerate():e.horizonPcsGenerate();if(null==s||!s.length)return null;let o=!1,r=s.find((e=>1===e.getInclusive()&&1===e.getKind()));if(!r){if(r=s.find((e=>1===e.getInclusive()&&0===e.getKind())),!r)return null;o=!0}const a=i.isPannableRectangle(),l=r.getCoord();if(o)return{isEnvelope:o,isPannable:a,vertices:l,coef:null,bbox:[l[0][0]-n,l[0][1]-n,l[1][0]+n,l[1][1]+n]};let c=0;const f=[];let[u,x]=l[0],[h,p]=l[0];for(let e=0,n=l.length;e<n;e++){c++,c===n&&(c=0);const[t,i]=l[e],[s,o]=l[c];if(o===i)f.push([t,s,i,o,2]);else{const e=(s-t)/(o-i||1e-4),n=t-e*i;i<o?f.push([e,n,i,o,0]):f.push([e,n,o,i,1])}u=u<t?u:t,x=x<i?x:i,h=h>t?h:t,p=p>i?p:i}return{isEnvelope:!1,isPannable:a,vertices:l,coef:f,bbox:[u,x,h,p]}}function _(e,n){const t=[],{cols:i,rows:s,xres:r,yres:a,usePixelCenter:l}=e;let{xmin:c,ymax:f}=e;if(l&&(c+=r/2,f-=a/2),!o(n)){for(let e=0;e<i;e++)for(let n=0;n<s;n++)t.push([c+r*e,f-a*n]);return{points:t}}const u=new Uint8Array(i*s);if(n.isEnvelope){const{bbox:[e,o,l,x]}=n;for(let h=0,m=0;h<i;h++){const i=c+r*h,p=n.isPannable||i>=e&&i<=l;for(let e=0;e<s;e++,m++){const n=f-a*e;p&&n>=o&&n<=x&&(t.push([i,n]),u[m]=1)}}return{points:t,mask:u}}const{coef:x}=n,h=[];for(let e=0;e<s;e++){const n=f-a*e,t=[],i=[];for(let e=0;e<x.length;e++){const[s,o,r,a,l]=x[e];if(n===r&&r===a)t.push(s),t.push(o),i.push(2),i.push(2);else if(n>=r&&n<=a){const e=s*n+o;t.push(e),i.push(l)}}let s=t;if(t.length>2){let e=2===i[0]?0:i[0],n=t[0];s=[];for(let o=1;o<i.length;o++)2===i[o]&&o!==i.length-1||(i[o]!==e&&(s.push(0===e?Math.min(n,t[o-1]):Math.max(n,t[o-1])),e=i[o],n=t[o]),o===i.length-1&&s.push(0===i[o]?Math.min(n,t[o]):Math.max(n,t[o])));s.sort(((e,n)=>e-n))}else t[0]>t[1]&&(s=[t[1],t[0]]);h.push(s)}for(let e=0,n=0;e<i;e++){const i=c+r*e;for(let e=0;e<s;e++,n++){const s=f-a*e,o=h[e];if(2===o.length)i>=o[0]&&i<=o[1]&&(t.push([i,s]),u[n]=1);else if(o.length>2){let e=!1;for(let n=0;n<o.length;n+=2)if(i>=o[n]&&i<=o[n+1]){e=!0;break}e&&(t.push([i,s]),u[n]=1)}}}return{points:t,mask:u}}function z(e){const n=j(e[0].spatialReference);if(e.length<2||!o(n))return e[0];let{xmin:i,xmax:s,ymin:r,ymax:a}=e[0];for(let t=1;t<e.length;t++){const i=e[t];s=i.xmax+n*t,r=Math.min(r,i.ymin),a=Math.max(a,i.ymax)}return new t({xmin:i,xmax:s,ymin:r,ymax:a,spatialReference:e[0].spatialReference})}function W(e,n,i=null,o=!0){if(e.spatialReference.equals(n))return e;const r=Y(e),a=j(e.spatialReference,!0),l=j(n);if(0===r||s(a)||s(l))return O(e,n,i,o);const c=e.clone().normalize();if(1===c.length&&e.xmax<a&&e.xmax-a/2>E(e.spatialReference)){const{xmin:n,xmax:i}=e;for(let s=0;s<=r;s++){const o=0===s?n:-a/2,l=s===r?i-a*s:a/2;c[s]=new t({xmin:o,xmax:l,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference})}}return z(c.map((e=>O(e,n,i,o))).filter((e=>!!e)))}function O(e,n,t=null,o=!0,r=!0){const l=e.spatialReference;if(l.equals(n))return e;d(l,n,t);const c=i(e,n,t);if(r&&n.isWebMercator&&c&&(c.ymax=Math.min(20037508.342787,c.ymax),c.ymin=Math.max(-20037508.342787,c.ymin),c.ymin>=c.ymax))return null;if(!o||!c)return c;const f=A(l,!0),u=A(n,!0);if(s(f)||s(u))return c;const x=E(l,.001),h=E(l,500),m=E(n,.001);if(Math.abs(c.xmin-u[0])<m&&Math.abs(c.xmax-u[1])<m){const i=Math.abs(e.xmin-f[0]),s=Math.abs(f[1]-e.xmax);if(i<x&&s>h){c.xmin=u[0];const i=[];i.push(new a(e.xmax,e.ymin,l)),i.push(new a(e.xmax,(e.ymin+e.ymax)/2,l)),i.push(new a(e.xmax,e.ymax,l));const s=i.map((e=>k(e,n,t))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));c.xmax=Math.max.apply(null,s)}if(s<x&&i>h){c.xmax=u[1];const i=[];i.push(new a(e.xmin,e.ymin,l)),i.push(new a(e.xmin,(e.ymin+e.ymax)/2,l)),i.push(new a(e.xmin,e.ymax,l));const s=i.map((e=>k(e,n,t))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));c.xmin=Math.min.apply(null,s)}}else{const e=E(n,.001);Math.abs(c.xmin-u[0])<e&&(c.xmin=u[0]),Math.abs(c.xmax-u[1])<e&&(c.xmax=u[1])}return c}function j(e,n=!1){const t=n?20037508.342787:20037508.342788905;return e.isWebMercator?2*t:e.wkid&&e.isGeographic?360:2*w[e.wkid]||null}function A(e,n=!1){if(e.isGeographic)return[-180,180];const t=j(e,n);return o(t)?[-t/2,t/2]:null}function I(e,n,t,i){let s=(e-n)/t;return s-Math.floor(s)!=0?s=Math.floor(s):i&&(s-=1),s}function Y(e,n=!1){const t=j(e.spatialReference);if(!o(t))return 0;const i=n?0:-t/2,s=E(e.spatialReference),r=!n&&Math.abs(e.xmax-t/2)<s?t/2:e.xmax,a=!n&&Math.abs(e.xmin+t/2)<s?-t/2:e.xmin;return I(r,i,t,!0)-I(a,i,t,!1)}function B(e){const n=e.storageInfo.origin.x,t=j(e.spatialReference,!0);if(!o(t))return{originX:n,halfWorldWidth:null,pyramidsInfo:null};const i=t/2,{nativePixelSize:s,storageInfo:r,extent:a}=e,{maximumPyramidLevel:l,blockWidth:c,pyramidScalingFactor:f}=r;let u=s.x;const x=[],h=o(e.transform)&&"gcs-shift"===e.transform.type,m=n+(h?0:i),p=h?t-n:i-n;for(let e=0;e<=l;e++){const e=(a.xmax-n)/u/c,t=e-Math.floor(e)==0?e:Math.ceil(e),i=p/u/c,s=i-Math.floor(i)==0?i:Math.ceil(i),o=Math.floor(m/u/c),r=Math.round(m/u)%c,l=(c-Math.round(p/u)%c)%c;x.push({resolutionX:u,blockWidth:c,datsetColumnCount:t,worldColumnCountFromOrigin:s,leftMargin:r,rightPadding:l,originColumnOffset:o}),u*=f}return{originX:n,halfWorldWidth:i,pyramidsInfo:x,hasGCSSShiftTransform:h}}function F(e){if(!e||e.isGeographic)return e;const n=String(e.wkid||e.wkt);let t;return P.has(n)?t=P.get(n):(t=(e.wkid?f.coordsys(e.wkid):f.fromString(u.PE_TYPE_PROJCS,e.wkt)).getGeogcs().getCode(),P.set(n,t)),new p({wkid:t})}function L(e){const n=e.isAdaptive&&null==e.spacing;let t=e.spacing||[32,32],i=q(e),s={cols:i.size[0]+1,rows:i.size[1]+1};const r=i.outofBoundPointCount>0&&i.outofBoundPointCount<i.offsets.length/2;let a=i.outofBoundPointCount===i.offsets.length/2||n&&r?[0,0]:M(i.offsets,s,t,4);const l=(a[0]+a[1])/2,c=e.projectedExtent.spatialReference,f=e.srcBufferExtent.spatialReference;if(n&&(r||l>4)&&(y(c,f,e.datumTransformation)&&(c.isGeographic||o(T(c))),t=[4,4],i=q({...e,spacing:t}),s={cols:i.size[0]+1,rows:i.size[1]+1},a=M(i.offsets,s,t,4)),i.error=a,t[0]>1&&(i.coefficients=J(i.offsets,s,r)),e.includeGCSGrid&&!c.isGeographic&&!c.isWebMercator)if(f.isGeographic)i.gcsGrid={offsets:i.offsets,coefficients:i.coefficients,spacing:t};else{const n=T(c);if(o(n)&&!n.isEnvelope){const n=F(c),o=W(e.projectedExtent,n),{offsets:a}=q({...e,srcBufferExtent:o,spacing:t}),l=J(a,s,r);i.gcsGrid={offsets:a,coefficients:l,spacing:t}}}return i}function q(e){const{projectedExtent:n,srcBufferExtent:t,pixelSize:i,datumTransformation:s,rasterTransform:r}=e,l=n.spatialReference,c=t.spatialReference;d(l,c);const{xmin:f,ymin:u,xmax:x,ymax:h}=n,m=j(c),p=o(m)&&(e.hasWrapAround||"gcs-shift"===(null==r?void 0:r.type)),g=e.spacing||[32,32],y=g[0]*i.x,M=g[1]*i.y,w=1===g[0],R=Math.ceil((x-f)/y-.1/g[0])+(w?0:1),P=Math.ceil((h-u)/M-.1/g[1])+(w?0:1),S=N({cols:R,rows:P,xmin:f,ymax:h,xres:y,yres:M,inSR:l,outSR:c,datumTransformation:s,preferPE:g[0]<=4,usePixelCenter:w}),b=[];let G,k=0;const v=w?-1:NaN,{xmin:T,xmax:C,ymax:_,width:z,height:W}=t,O=E(c,500);for(let e=0;e<R;e++){const n=[];for(let t=0;t<P;t++){let i=S[e*P+t];if(p&&i[0]>C&&i[0]>m/2-O&&(i[0]-=m),!i||isNaN(i[0])||isNaN(i[1]))b.push(v),b.push(v),n.push(null),k++;else{if(r){const e=r.inverseTransform(new a({x:i[0],y:i[1],spatialReference:c}));i=[e.x,e.y]}n.push(i),e>0&&p&&G[t]&&i[0]<G[t][0]&&(i[0]+=m),b.push((i[0]-T)/z),b.push((_-i[1])/W)}}G=n}return{offsets:b,error:null,coefficients:null,outofBoundPointCount:k,spacing:g,size:w?[R,P]:[R-1,P-1]}}function J(e,n,t){const{cols:i,rows:s}=n,o=new Float32Array((i-1)*(s-1)*2*6),r=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),a=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let n=0;n<i-1;n++){for(let t=0;t<s-1;t++){let l=n*s*2+2*t;const c=e[l],f=e[l+1],u=e[l+2],x=e[l+3];l+=2*s;const h=e[l],m=e[l+1],p=e[l+2],g=e[l+3];let y=0,d=12*(t*(i-1)+n);for(let e=0;e<3;e++)o[d++]=r[y++]*c+r[y++]*u+r[y++]*p;y=0;for(let e=0;e<3;e++)o[d++]=r[y++]*f+r[y++]*x+r[y++]*g;y=0;for(let e=0;e<3;e++)o[d++]=a[y++]*c+a[y++]*h+a[y++]*p;y=0;for(let e=0;e<3;e++)o[d++]=a[y++]*f+a[y++]*m+a[y++]*g}if(t)for(let e=0;e<o.length;e++)isNaN(o[e])&&(o[e]=-1)}return o}function X(e){const n=e.clone().normalize();return 1===n.length?n[0]:z(n)}function K(e,n,t){const{storageInfo:i,pixelSize:s}=n;let r,l=!1;const{pyramidResolutions:c}=i;if(o(c)&&c.length){const i=(e.x+e.y)/2,o=c[c.length-1],f=(o.x+o.y)/2,u=(s.x+s.y)/2;if(i<=u)r=0;else if(i>=f)r=c.length,l=i/f>8;else{let e,n=u;for(let s=1;s<=c.length;s++){if(e=(c[s-1].x+c[s-1].y)/2,i<=e){i===e?r=s:"down"===t?(r=s-1,l=i/n>8):r="up"===t||i-n>e-i||i/n>2?s:s-1;break}n=e}}const x=0===r?s:c[r-1];return{pyramidLevel:r,pyramidResolution:new a({x:x.x,y:x.y,spatialReference:n.spatialReference}),excessiveReading:l}}const f=Math.log(e.x/s.x)/Math.LN2,u=Math.log(e.y/s.y)/Math.LN2,x=n.storageInfo.maximumPyramidLevel||0;r="down"===t?Math.floor(Math.min(f,u)):"up"===t?Math.ceil(Math.max(f,u)):Math.round((f+u)/2),r<0?r=0:r>x&&(l=r>x+3,r=x);const h=2**r;return{pyramidLevel:r,pyramidResolution:new a({x:h*n.nativePixelSize.x,y:h*n.nativePixelSize.y,spatialReference:n.spatialReference}),excessiveReading:l}}function U(e,n,t=512,i=!0){const{extent:s,spatialReference:o,pixelSize:l}=e,c=G(new a({x:l.x,y:l.y,spatialReference:o}),n,s);if(null==c)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const f=(c.x+c.y)/2,u=r(n),x=f*u*96*39.37,h=n.isGeographic?256/t*295828763.7958547:256/t*591657527.591555;let m="vector-magdir"===e.dataType||"vector-uv"===e.dataType;const p=W(s,n);m||i&&(n.isGeographic||n.isWebMercator)&&(m=p.xmin*p.xmax<0);let g,y=x;const d=1.001;if(m){y=h;const e=n.isGeographic?1341104507446289e-21:.29858214164761665,t=e*(96*u*39.37),i=n.isGeographic?4326:3857;g=G(new a({x:e,y:e,spatialReference:{wkid:i}}),o,p),g.x*=y/t,g.y*=y/t}else{g={x:l.x,y:l.y};const n=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let t=0;for(;y<h*(d/2)&&t<n;)t++,y*=2,g.x*=2,g.y*=2;Math.max(y,h)/Math.min(y,h)<=d&&(y=h)}const M=[y],w=[{x:g.x,y:g.y}],R=Math.min(70.5310735,x)/d;for(;y>=R;)y/=2,g.x/=2,g.y/=2,M.push(y),w.push({x:g.x,y:g.y});return{projectedPixelSize:c,scales:M,srcResolutions:w,isCustomTilingScheme:!m}}export{U as $,W as B,L as D,S as G,B as K,j as L,G as N,k as T,X as V,Y as X,K as Z,b as k,y};
