import{at as e,av as t,au as o,s as i,e as r,bI as n,b3 as a,c6 as l,c7 as s,bb as c,r as f,c8 as m,c9 as u,bt as p,x as y,ca as h,cb as g,cc as d,bf as S}from"../main.js";import{t as v,o as b,x as N,a as C,c as k,A as O,$ as M,K as x}from"./CIMSymbolHelper-cbb4397a.js";import{q as P,k as w,m as L}from"./enums-7acaa04d.js";import{q as I,C as X,B as z,v as J}from"./quantizationUtils-6ec6d37f.js";function H(e){if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&1===t.length?H(t[0]):null}case"CIMVectorMarker":{var t;const o=e.markerGraphics;if(!o||1!==o.length)return null;const i=o[0];if(!i)return null;const r=i.geometry;if(!r)return null;const n=i.symbol;return!n||"CIMPolygonSymbol"!==n.type&&"CIMLineSymbol"!==n.type||null!=(t=n.symbolLayers)&&t.some((e=>!!e.effects))?null:{geom:r,asFill:"CIMPolygonSymbol"===n.type}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function A(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return[t,i,o,r]}function R(t){return t?t.rings?A(t.rings):t.paths?A(t.paths):e(t)?[t.xmin,t.ymin,t.xmax,t.ymax]:null:null}function Y(e,t,o,i,r){const[n,a,l,s]=e;if(l<n||s<a)return[0,0,0];const c=l-n,f=s-a,m=Math.floor(31.5),u=(128-2*(m+1))/Math.max(c,f),p=Math.round(c*u)+2*m,y=Math.round(f*u)+2*m;let h=1;t&&(h=y/u/(t.ymax-t.ymin));let g=0,d=0;if(i)if(r){if(t&&o&&t.ymax-t.ymin>0){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin);g=i.x/(o*e),d=i.y/o}}else g=i.x,d=i.y;return g=.5*(t.xmax+t.xmin)+g*(t.xmax-t.xmin),d=.5*(t.ymax+t.ymin)+d*(t.ymax-t.ymin),g-=n,d-=a,g*=u,d*=u,g+=m,d+=m,[h,g/p-.5,-(d/y-.5)]}function F(e){const t=function(e){return e?e.rings?e.rings:e.paths?e.paths:void 0!==e.xmin&&void 0!==e.ymin&&void 0!==e.xmax&&void 0!==e.ymax?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]:null:null}(e.geom),o=function(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return new v(t,i,o-t,r-i)}(t),i=Math.floor(31.5),r=(128-2*(i+1))/Math.max(o.width,o.height),n=Math.round(o.width*r)+2*i,a=Math.round(o.height*r)+2*i,l=[];for(const n of t)if(n&&n.length>1){const t=[];for(const a of n){let[n,l]=a;n-=o.x,l-=o.y,n*=r,l*=r,n+=i-.5,l+=i-.5,e.asFill?t.push([n,l]):t.push([Math.round(n),Math.round(l)])}if(e.asFill){const e=t.length-1;t[0][0]===t[e][0]&&t[0][1]===t[e][1]||t.push(t[0])}l.push(t)}const s=function(e,t,o,i){const r=t*o,n=new Array(r),a=i*i+1;for(let e=0;e<r;++e)n[e]=a;for(const r of e){const e=r.length;for(let a=1;a<e;++a){const e=r[a-1],l=r[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s)-i,p=Math.floor(c)+i,y=Math.floor(f)-i,h=Math.floor(m)+i;u<0&&(u=0),p>t&&(p=t),y<0&&(y=0),h>o&&(h=o);const g=l[0]-e[0],d=l[1]-e[1],S=g*g+d*d;for(let i=u;i<p;i++)for(let r=y;r<h;r++){let a,s,c=(i-e[0])*g+(r-e[1])*d;c<0?(a=e[0],s=e[1]):c>S?(a=l[0],s=l[1]):(c/=S,a=e[0]+c*g,s=e[1]+c*d);const f=(i-a)*(i-a)+(r-s)*(r-s),m=(o-r-1)*t+i;f<n[m]&&(n[m]=f)}}}for(let e=0;e<r;++e)n[e]=Math.sqrt(n[e]);return n}(l,n,a,i);return e.asFill&&function(e,t,o,i,r){for(const n of e){const e=n.length;for(let a=1;a<e;++a){const e=n[a-1],l=n[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s),p=Math.floor(c)+1,y=Math.floor(f),h=Math.floor(m)+1;u<i&&(u=i),p>t-i&&(p=t-i),y<i&&(y=i),h>o-i&&(h=o-i);for(let n=y;n<h;++n){if(e[1]>n==l[1]>n)continue;const a=(o-n-1)*t;for(let t=u;t<p;++t)t<(l[0]-e[0])*(n-e[1])/(l[1]-e[1])+e[0]&&(r[a+t]=-r[a+t]);for(let e=i;e<u;++e)r[a+e]=-r[a+e]}}}}(l,n,a,i,s),[$(s,i),n,a]}function $(e,t){const o=2*t,i=e.length,r=new Uint8Array(4*i);for(let t=0;t<i;++t){const i=.5-e[t]/o;b(i,r,4*t)}return r}class E{static executeEffects(e,t,o){const i=C(t);let r=new k(i);for(const t of e){const e=O(t);e&&(r=e.execute(r,t,1.3333333333333333,o))}return r}static next(e){const t=e.next();return N(t),t}static applyEffects(e,i,r){if(!e)return i;let n=new k(i);for(const t of e){const e=O(t);e&&(n=e.execute(n,t,1,r))}let a,l=null;for(;a=n.next();)l?t(l)?t(a)&&l.paths.push(...a.paths):o(l)&&o(a)&&l.rings.push(...a.rings):l=a;return l}}function T(e,t,o,r,n){const a=e.referencesGeometry()&&n?W(t,r,n):t,l=e.repurposeFeature(a);try{return e.evaluate({...o,$feature:l})}catch(e){return i.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",e),null}}const G=new Map;function W(e,t,o){const{transform:n,hasZ:a,hasM:l}=o;G.has(t)||G.set(t,function(e){const t={};switch(e){case"esriGeometryPoint":return(e,o,i,r)=>J(o,t,e,i,r);case"esriGeometryPolygon":return(e,o,i,r)=>z(o,t,e,i,r);case"esriGeometryPolyline":return(e,o,i,r)=>X(o,t,e,i,r);case"esriGeometryMultipoint":return(e,o,i,r)=>I(o,t,e,i,r);default:return i.getLogger("esri.views.2d.support.arcadeOnDemand").error(new r("mapview-arcade",`Unable to handle geometryType: ${e}`)),e=>e}}(t));const s=G.get(t)(e.geometry,n,a,l);return{...e,geometry:s}}function D(e){const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function U(e){const t=function(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(e)+function(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}(e);return D(e.family)+(t.length>0?t:"-regular")}const j=i.getLogger("esri.symbols.cim.cimAnalyzer");function q(e){switch(e){case"Butt":return w.BUTT;case"Square":return w.SQUARE;default:return w.ROUND}}function B(e){switch(e){case"Bevel":return L.BEVEL;case"Miter":return L.MITER;default:return L.ROUND}}function V(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function K(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function Q(e,t,o,i){let r;e[t]?r=e[t]:(r={},e[t]=r),r[o]=i}function Z(e){const t=e.markerPlacement;return t&&t.angleToLine?P.MAP:P.SCREEN}async function _(e,t,o,i,r){const a=null!=i?i:[];if(!e)return a;let l,s;const c={};if("CIMSymbolReference"!==e.type)return j.error("Expect cim type to be 'CIMSymbolReference'"),a;if(l=e.symbol,s=e.primitiveOverrides,s){const e=[];for(const o of s){const i=o.valueExpressionInfo;if(i&&t){const r=i.expression,a=n(r,t.spatialReference,t.fields).then((e=>{e&&Q(c,o.primitiveName,o.propertyName,e)}));e.push(a)}else null!=o.value&&Q(c,o.primitiveName,o.propertyName,o.value)}e.length>0&&await Promise.all(e)}const f=[];switch(Ne(l,o,f),f.length>0&&await Promise.all(f),l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":!function(e,t,o,i,r,n,a){if(!e)return;const l=e.symbolLayers;if(!l)return;const s=e.effects;let c;const f=M.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(c=P.MAP);let m=l.length;for(;m--;){const u=l[m];if(!u||!1===u.enable)continue;let p;s&&s.length&&(p=[...s]);const y=u.effects;y&&y.length&&(s?p.push(...y):p=[...y]);const h=[];let g;x.findEffectOverrides(p,t,h),g=h.length>0?ge(p,h,o,i):p;const d=[];switch(x.findApplicableOverrides(u,t,d),u.type){case"CIMSolidFill":ee(u,g,o,d,i,r);break;case"CIMPictureFill":te(u,g,o,d,i,n,r);break;case"CIMHatchFill":oe(u,g,o,d,i,r);break;case"CIMGradientFill":ie(u,g,o,d,i,r);break;case"CIMSolidStroke":re(u,g,o,d,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMPictureStroke":ne(u,g,o,d,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMGradientStroke":ae(u,g,o,d,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMCharacterMarker":if(le(u,g,o,d,i,r))break;break;case"CIMPictureMarker":if(le(u,g,o,d,i,r))break;"CIMLineSymbol"===e.type&&(c=Z(u)),se(u,g,o,d,i,n,r,c,f);break;case"CIMVectorMarker":if(le(u,g,o,d,i,r))break;"CIMLineSymbol"===e.type&&(c=Z(u)),ce(u,g,o,d,i,r,n,c,f,a);break;default:j.error("Cannot analyze CIM layer",u.type)}}}(l,s,c,t,a,o,r)}return a}function ee(e,t,o,i,r,n){const a=e.primitiveName,c=l(e.color),[f,m]=be(i,a,t,null),u=s(JSON.stringify(e)+m).toString();n.push({type:"fill",templateHash:u,materialHash:f?()=>u:u,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:he(a,o,"Color",r,c,ye),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t})}function te(e,t,o,i,r,n,a){const m=e.primitiveName,u=e.tintColor?l(e.tintColor):{r:255,g:255,b:255,a:1},[p,y]=be(i,m,t,null),h=s(JSON.stringify(e)+y).toString(),g=s(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let d=c(e.scaleX);if("width"in e){const t=e.width;let o=1;const i=n.getResource(e.url);f(i)&&(o=i.width/i.height),d/=o*(e.height/t)}a.push({type:"fill",templateHash:h,materialHash:p?()=>g:g,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:he(m,o,"TintColor",r,u,ye),height:he(m,o,"Height",r,e.height),scaleX:he(m,o,"ScaleX",r,d),angle:he(m,o,"Rotation",r,c(e.rotation)),offsetX:he(m,o,"OffsetX",r,c(e.offsetX)),offsetY:he(m,o,"OffsetY",r,c(e.offsetY)),url:e.url})}function oe(e,t,o,i,r,n){const a=["Rotation","OffsetX","OffsetY"],l=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===a.indexOf(t.propertyName))),f=e.primitiveName,[m,u]=be(i,f,t,null),p=s(JSON.stringify(e)+u).toString(),y=s(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();n.push({type:"fill",templateHash:p,materialHash:m?Se(y,o,l,r):y,cim:e,materialOverrides:l,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:he(f,o,"Separation",r,e.separation),scaleX:1,angle:he(f,o,"Rotation",r,c(e.rotation)),offsetX:he(f,o,"OffsetX",r,c(e.offsetX)),offsetY:he(f,o,"OffsetY",r,c(e.offsetY))})}function ie(e,t,o,i,r,n){const a=e.primitiveName,[l,c]=be(i,a,t,null),f=s(JSON.stringify(e)+c).toString();n.push({type:"fill",templateHash:f,materialHash:l?Se(f,o,i,r):f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function re(e,t,o,i,r,n,a,c){const f=e.primitiveName,m=l(e.color),u=void 0!==e.width?e.width:4,p=q(e.capStyle),y=B(e.joinStyle),h=e.miterLimit,[g,d]=be(i,f,t,null),S=s(JSON.stringify(e)+d).toString();let v,b;if(t&&t instanceof Array&&t.length>0){const e=t[t.length-1];if("CIMGeometricEffectDashes"===e.type&&"NoConstraint"===e.lineDashEnding&&null===e.offsetAlongLine){const e=(t=[...t]).pop();v=e.dashTemplate,b=e.scaleDash}}n.push({type:"line",templateHash:S,materialHash:g?()=>S:S,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:t,color:he(f,o,"Color",r,m,ye),width:he(f,o,"Width",r,u),cap:he(f,o,"CapStyle",r,p),join:he(f,o,"JoinStyle",r,y),miterLimit:he(f,o,"MiterLimit",r,h),referenceWidth:c,zOrder:pe(e.name),dashTemplate:v,scaleDash:b})}function ne(e,t,o,i,r,n,a,c){const f=s(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),m=e.primitiveName,u=l(e.tintColor),p=void 0!==e.width?e.width:4,y=q(e.capStyle),h=B(e.joinStyle),g=e.miterLimit,[d,S]=be(i,m,t,null),v=s(JSON.stringify(e)+S).toString();n.push({type:"line",templateHash:v,materialHash:d?()=>f:f,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:t,color:he(m,o,"TintColor",r,u,ye),width:he(m,o,"Width",r,p),cap:he(m,o,"CapStyle",r,y),join:he(m,o,"JoinStyle",r,h),miterLimit:he(m,o,"MiterLimit",r,g),referenceWidth:c,zOrder:pe(e.name),dashTemplate:null,scaleDash:!1,url:e.url})}function ae(e,t,o,i,r,n,a,l){const c=e.primitiveName,f=void 0!==e.width?e.width:4,m=q(e.capStyle),u=B(e.joinStyle),p=e.miterLimit,[y,h]=be(i,c,t,null),g=s(JSON.stringify(e)+h).toString();n.push({type:"line",templateHash:g,materialHash:y?Se(g,o,i,r):g,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:he(c,o,"Width",r,f),cap:he(c,o,"CapStyle",r,m),join:he(c,o,"JoinStyle",r,u),miterLimit:he(c,o,"MiterLimit",r,p),referenceWidth:l,zOrder:pe(e.name),dashTemplate:null,scaleDash:!1})}function le(e,t,o,i,r,n){const a=e.markerPlacement;if(!a||"CIMMarkerPlacementInsidePolygon"!==a.type)return!1;const l=a,f=["Rotation","OffsetX","OffsetY"],m=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===f.indexOf(t.propertyName))),u="url"in e?e.url:null,[p,y]=be(i,l.primitiveName,t,null),h=s(JSON.stringify(e)+y).toString();let g=l.stepY,d=null,S=1;return a.shiftOddRows&&(g*=2,d=function(e){return e?2*e:0},S=.5),n.push({type:"fill",templateHash:h,materialHash:p?Se(h,o,m,r):h,cim:e,materialOverrides:m,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:he(l.primitiveName,o,"StepY",r,g,d),scaleX:S,angle:he(l.primitiveName,o,"GridAngle",r,l.gridAngle),offsetX:he(l.primitiveName,o,"OffsetX",r,c(l.offsetX)),offsetY:he(l.primitiveName,o,"OffsetY",r,c(l.offsetY)),url:u}),!0}function se(e,t,o,i,r,n,a,m,u){var p;const y=e.primitiveName,h=c(e.size);let g=c(e.scaleX);const d=c(e.rotation),S=c(e.offsetX),v=c(e.offsetY),b=e.tintColor?l(e.tintColor):{r:255,g:255,b:255,a:1},N=s(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),C=de(e.markerPlacement,i,o,r),[k,O]=be(i,y,t,C),M=s(JSON.stringify(e)+O).toString(),x=null!=(p=e.anchorPoint)?p:{x:0,y:0};if("width"in e){const t=e.width;let o=1;const i=n.getResource(e.url);f(i)&&(o=i.width/i.height),g/=o*(h/t)}a.push({type:"marker",templateHash:M,materialHash:k?()=>N:N,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:!1,alignment:m,size:he(y,o,"Size",r,h),scaleX:he(y,o,"ScaleX",r,g),rotation:he(y,o,"Rotation",r,d),offsetX:he(y,o,"OffsetX",r,S),offsetY:he(y,o,"OffsetY",r,v),color:he(y,o,"TintColor",r,b,ye),anchorPoint:{x:x.x,y:-x.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:u,sizeRatio:1,markerPlacement:e.markerPlacement,url:e.url})}function ce(e,t,o,i,r,n,a,l,s,c){const f=e.markerGraphics;if(!f)return;let m=0;if(e.scaleSymbolsProportionally){const t=e.frame;t&&(m=t.ymax-t.ymin)}const u=de(e.markerPlacement,i,o,r);for(const p of f)if(p){const f=p.symbol;if(!f)continue;switch(f.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":me(e,t,u,p,i,o,r,n,a,l,s,m,c);break;case"CIMTextSymbol":fe(e,t,u,p,o,i,r,n,l,s,m)}}}function fe(e,t,o,i,r,n,a,f,y,h,g){x.findApplicableOverrides(i,n,[]);const d=i.geometry;if(!("x"in d)||!("y"in d))return;const S=i.symbol,v=function(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}(S),b=function(e){let t="",o="";if(e){const i=e.toLowerCase();-1!==i.indexOf("italic")?t="italic":-1!==i.indexOf("oblique")&&(t="oblique"),-1!==i.indexOf("bold")?o="bold":-1!==i.indexOf("light")&&(o="lighter")}return{style:t,weight:o}}(S.fontStyleName),N=D(S.fontFamilyName);S.font={family:N,decoration:v,...b};const C=e.frame,k=d.x-.5*(C.xmin+C.xmax),O=d.y-.5*(C.ymin+C.ymax),P=e.size/g,w=e.primitiveName,L=c(S.height)*P,I=c(S.angle),X=c(e.offsetX)+(c(S.offsetX)+k)*P,z=c(e.offsetY)+(c(S.offsetY)+O)*P,J=l(M.getFillColor(S));let H=l(M.getStrokeColor(S)),A=M.getStrokeWidth(S);A||(H=l(M.getFillColor(S.haloSymbol)),A=S.haloSize*P);const[R,Y]=be(n,w,t,o),F=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),$=s(JSON.stringify(i)+F+Y).toString();let E=he(i.primitiveName,r,"TextString",a,i.textString,m,S.textCase);if(null==E)return;const{fontStyleName:T}=S,G=N+(T?"-"+T.toLowerCase():"-regular"),W=G;"string"==typeof E&&E.indexOf("[")>-1&&S.fieldMap&&(E=u(S.fieldMap,E,S.textCase)),f.push({type:"text",templateHash:$,materialHash:R||"function"==typeof E||E.match(/\[(.*?)\]/)?(e,t,o)=>W+"-"+p(E,e,t,o):W+"-"+s(E),cim:S,materialOverrides:null,colorLocked:e.colorLocked,effects:t,alignment:y,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:G,decoration:v,weight:he(w,r,"Weight",a,b.weight),style:he(w,r,"Size",a,b.style),size:he(w,r,"Size",a,L),angle:he(w,r,"Rotation",a,I),offsetX:he(w,r,"OffsetX",a,X),offsetY:he(w,r,"OffsetY",a,z),horizontalAlignment:V(S.horizontalAlignment),verticalAlignment:K(S.verticalAlignment),text:E,color:J,outlineColor:H,outlineSize:A,referenceSize:h,sizeRatio:1,markerPlacement:o})}function me(e,t,o,i,r,n,a,m,u,p,y,h,g){const d=i.symbol,S=d.symbolLayers;if(!S)return;if(g)return void ue(e,t,o,i,n,r,a,m,u,p,y,h);let v=S.length;if(Ce(S))return void function(e,t,o,i,r,n,a,f,m,u,p,y){const h=i.geometry,g=r[0],d=r[1],S=R(h);if(!S)return;const[v,b,N]=Y(S,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),C={type:"sdf",geom:h,asFill:!0},k=e.primitiveName,O=c(e.size),x=c(e.rotation),P=c(e.offsetX),w=c(e.offsetY),L=d.path,I=d.primitiveName,X=g.primitiveName,z=l(M.getFillColor(d)),J=l(M.getStrokeColor(g)),H=M.getStrokeWidth(g);let A=!1,F="";for(const e of n)e.primitiveName!==I&&e.primitiveName!==X&&e.primitiveName!==k||(void 0!==e.value?F+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(A=!0));const $=JSON.stringify({...e,markerGraphics:null}),E=s(JSON.stringify(C)+L).toString(),T={type:"marker",templateHash:s(JSON.stringify(i)+JSON.stringify(d)+JSON.stringify(g)+$+F).toString(),materialHash:A?()=>E:E,cim:C,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:u,anchorPoint:{x:b,y:N},isAbsoluteAnchorPoint:!1,size:he(e.primitiveName,a,"Size",f,O),rotation:he(e.primitiveName,a,"Rotation",f,x),offsetX:he(e.primitiveName,a,"OffsetX",f,P),offsetY:he(e.primitiveName,a,"OffsetY",f,w),scaleX:1,frameHeight:y,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:v,color:he(I,a,"Color",f,z,ye),outlineColor:he(X,a,"Color",f,J,ye),outlineWidth:he(X,a,"Width",f,H),markerPlacement:o,path:L};m.push(T)}(e,t,o,i,S,r,n,a,m,p,y,h);const b=E.applyEffects(d.effects,i.geometry,u.geometryEngine);if(b)for(;v--;){const g=S[v];if(g&&!1!==g.enable)switch(g.type){case"CIMSolidFill":case"CIMSolidStroke":{var N;const d=E.applyEffects(g.effects,b,u.geometryEngine),S=R(d);if(!S)continue;const[v,C,k]=Y(S,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),O="CIMSolidFill"===g.type,x={type:"sdf",geom:d,asFill:O},P=e.primitiveName,w=null!=(N=c(e.size))?N:10,L=c(e.rotation),I=c(e.offsetX),X=c(e.offsetY),z=g.path,J=g.primitiveName,H=l(O?M.getFillColor(g):M.getStrokeColor(g)),A=O?{r:0,g:0,b:0,a:0}:l(M.getStrokeColor(g)),F=M.getStrokeWidth(g);if(!O&&!F)break;let $=!1,T="";for(const e of r)e.primitiveName!==J&&e.primitiveName!==P||(void 0!==e.value?T+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&($=!0));f(t)&&"function"==typeof t&&($=!0);const G=JSON.stringify({...e,markerGraphics:null}),W=s(JSON.stringify(x)+z).toString(),D={type:"marker",templateHash:s(JSON.stringify(i)+JSON.stringify(g)+G+T).toString(),materialHash:$?()=>W:W,cim:x,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:p,anchorPoint:{x:C,y:k},isAbsoluteAnchorPoint:!1,size:he(e.primitiveName,n,"Size",a,w),rotation:he(e.primitiveName,n,"Rotation",a,L),offsetX:he(e.primitiveName,n,"OffsetX",a,I),offsetY:he(e.primitiveName,n,"OffsetY",a,X),scaleX:1,frameHeight:h,rotateClockwise:e.rotateClockwise,referenceSize:y,sizeRatio:v,color:he(J,n,"Color",a,H,ye),outlineColor:he(J,n,"Color",a,A,ye),outlineWidth:he(J,n,"Width",a,F),markerPlacement:o,path:z};m.push(D);break}default:ue(e,t,o,i,n,r,a,m,u,p,y,h)}}}function ue(e,t,o,i,r,n,a,l,m,u,p,h){const g=function(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}(e,i);let d=[];const S=["Rotation","OffsetX","OffsetY"];d=n.filter((t=>t.primitiveName!==e.primitiveName||-1===S.indexOf(t.propertyName)));let v="";for(const e of n)void 0!==e.value&&(v+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`);const[b,N,C]=M.getTextureAnchor(g,m),k=e.primitiveName,O=c(e.rotation),x=c(e.offsetX),P=c(e.offsetY),w=s(JSON.stringify(g)+v).toString(),L={type:"marker",templateHash:w,materialHash:d.length>0||f(t)&&"function"==typeof t?Se(w,r,d,a):w,cim:g,materialOverrides:d,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:u,anchorPoint:{x:b,y:N},isAbsoluteAnchorPoint:!1,size:e.size,rotation:he(k,r,"Rotation",a,O),offsetX:he(k,r,"OffsetX",a,x),offsetY:he(k,r,"OffsetY",a,P),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:h,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:C/y(e.size),markerPlacement:o};l.push(L)}function pe(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function ye(e){if(!e||0===e.length)return null;const t=new S(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function he(e,t,o,i,r,n,a){const l=t[e];if(l){const e=l[o];if("string"==typeof e||"number"==typeof e||e instanceof Array)return n?n.call(null,e,a):e;if(null!=e&&e instanceof h)return(t,o,l)=>{let s=T(e,t,{$view:l},i.geometryType,o);return null!==s&&n&&(s=n.call(null,s,a)),null!==s?s:r}}return r}function ge(e,t,o,i){for(const e of t)if(e.valueExpressionInfo){const t=o[e.primitiveName]&&o[e.primitiveName][e.propertyName];t instanceof h&&(e.fn=(e,o,r)=>T(t,e,{$view:r},i.geometryType,o))}const r=e=>e?e.charAt(0).toLowerCase()+e.substr(1):e;return(o,i,n)=>{for(const e of t)e.fn&&(e.value=e.fn(o,i,n));const l=[];for(let o of e){var s;const e=null==(s=o)?void 0:s.primitiveName;if(e){let i=!1;for(const n of t)if(n.primitiveName===e){const e=r(n.propertyName);null!=n.value&&n.value!==o[e]&&(i||(o=a(o),i=!0),o[e]=n.value)}}l.push(o)}return l}}function de(e,t,o,i){const r=[];if(x.findApplicableOverrides(e,t,r),0===r.length)return e;for(const e of r)if(e.valueExpressionInfo){const t=o[e.primitiveName]&&o[e.primitiveName][e.propertyName];t instanceof h&&(e.fn=(e,o,r)=>T(t,e,{$view:r},i.geometryType,o))}const n=e=>e?e.charAt(0).toLowerCase()+e.substr(1):e;return(t,o,i)=>{for(const e of r)e.fn&&(e.value=e.fn(t,o,i));const l=a(e),s=e.primitiveName;for(const e of r)if(e.primitiveName===s){const t=n(e.propertyName);null!=e.value&&e.value!==l[t]&&(l[t]=e.value)}return l}}function Se(e,t,o,i){for(const e of o)if(e.valueExpressionInfo){const o=t[e.primitiveName]&&t[e.primitiveName][e.propertyName];o instanceof h&&(e.fn=(e,t,r)=>T(o,e,{$view:r},i.geometryType,t))}return(t,i,r)=>{for(const e of o)e.fn&&(e.value=e.fn(t,i,r));return s(e+x.buildOverrideKey(o)).toString()}}function ve(e,t){if(!t||0===t.length)return e;const o=JSON.parse(JSON.stringify(e));return x.applyOverrides(o,t),o}function be(e,t,o,i){let r=!1,n="";for(const o of e)o.primitiveName===t&&(void 0!==o.value?n+=`-${o.primitiveName}-${o.propertyName}-${JSON.stringify(o.value)}`:o.valueExpressionInfo&&(r=!0));return f(o)&&"function"==typeof o&&(r=!0),f(i)&&"function"==typeof i&&(r=!0),[r,n]}function Ne(e,t,o){if(e&&t)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const i=e.symbolLayers;if(!i)return;for(const e of i)switch(Oe(e,t,o),e.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in e&&e.url&&o.push(t.fetchResource(e.url,null));break;case"CIMVectorMarker":{const i=e.markerGraphics;if(!i)continue;for(const e of i)if(e){const i=e.symbol;i&&Ne(i,t,o)}}}}}}const Ce=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&!e[0].effects&&!e[1].effects;let ke;function Oe(e,t,o){e.effects&&!f(t.geometryEngine)&&(ke?o.push(ke):g(e.effects)&&(ke=d(),o.push(ke),ke.then((e=>t.geometryEngine=e))))}export{_ as H,E as f,F as m,U as n,ve as o,H as r,T as s};
