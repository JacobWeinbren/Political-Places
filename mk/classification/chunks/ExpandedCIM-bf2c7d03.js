import{at as e,av as t,au as o,s as i,e as r,bG as n,b3 as a,c4 as l,r as s,x as c,c5 as f,be as m}from"../main.js";import{t as u,o as p,x as y,c as h,f as g,A as d,$ as S,K as v,i as b,M as N,h as C,k,e as O,p as M,C as x}from"./CIMSymbolHelper-6613d020.js";import{q as P,k as w,m as L}from"./enums-c2efc4ce.js";import{q as I,C as X,B as z,v as H}from"./quantizationUtils-2dc92c9e.js";import{b as J}from"./Utils-a0a3c935.js";import{L as R}from"./MaterialKey-44c98e9c.js";function A(e){if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&1===t.length?A(t[0]):null}case"CIMVectorMarker":{var t;const o=e.markerGraphics;if(!o||1!==o.length)return null;const i=o[0];if(!i)return null;const r=i.geometry;if(!r)return null;const n=i.symbol;return!n||"CIMPolygonSymbol"!==n.type&&"CIMLineSymbol"!==n.type||null!=(t=n.symbolLayers)&&t.some((e=>!!e.effects))?null:{geom:r,asFill:"CIMPolygonSymbol"===n.type}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function Y(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return[t,i,o,r]}function F(t){return t?t.rings?Y(t.rings):t.paths?Y(t.paths):e(t)?[t.xmin,t.ymin,t.xmax,t.ymax]:null:null}function E(e,t,o,i,r){const[n,a,l,s]=e;if(l<n||s<a)return[0,0,0];const c=l-n,f=s-a,m=Math.floor(31.5),u=(128-2*(m+1))/Math.max(c,f),p=Math.round(c*u)+2*m,y=Math.round(f*u)+2*m;let h=1;t&&(h=y/u/(t.ymax-t.ymin));let g=0,d=0;if(i)if(r){if(t&&o&&t.ymax-t.ymin>0){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin);g=i.x/(o*e),d=i.y/o}}else g=i.x,d=i.y;return g=.5*(t.xmax+t.xmin)+g*(t.xmax-t.xmin),d=.5*(t.ymax+t.ymin)+d*(t.ymax-t.ymin),g-=n,d-=a,g*=u,d*=u,g+=m,d+=m,[h,g/p-.5,-(d/y-.5)]}function $(e){const t=function(e){return e?e.rings?e.rings:e.paths?e.paths:void 0!==e.xmin&&void 0!==e.ymin&&void 0!==e.xmax&&void 0!==e.ymax?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]:null:null}(e.geom),o=function(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return new u(t,i,o-t,r-i)}(t),i=Math.floor(31.5),r=(128-2*(i+1))/Math.max(o.width,o.height),n=Math.round(o.width*r)+2*i,a=Math.round(o.height*r)+2*i,l=[];for(const n of t)if(n&&n.length>1){const t=[];for(const a of n){let[n,l]=a;n-=o.x,l-=o.y,n*=r,l*=r,n+=i-.5,l+=i-.5,e.asFill?t.push([n,l]):t.push([Math.round(n),Math.round(l)])}if(e.asFill){const e=t.length-1;t[0][0]===t[e][0]&&t[0][1]===t[e][1]||t.push(t[0])}l.push(t)}const s=function(e,t,o,i){const r=t*o,n=new Array(r),a=i*i+1;for(let e=0;e<r;++e)n[e]=a;for(const r of e){const e=r.length;for(let a=1;a<e;++a){const e=r[a-1],l=r[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s)-i,p=Math.floor(c)+i,y=Math.floor(f)-i,h=Math.floor(m)+i;u<0&&(u=0),p>t&&(p=t),y<0&&(y=0),h>o&&(h=o);const g=l[0]-e[0],d=l[1]-e[1],S=g*g+d*d;for(let i=u;i<p;i++)for(let r=y;r<h;r++){let a,s,c=(i-e[0])*g+(r-e[1])*d;c<0?(a=e[0],s=e[1]):c>S?(a=l[0],s=l[1]):(c/=S,a=e[0]+c*g,s=e[1]+c*d);const f=(i-a)*(i-a)+(r-s)*(r-s),m=(o-r-1)*t+i;f<n[m]&&(n[m]=f)}}}for(let e=0;e<r;++e)n[e]=Math.sqrt(n[e]);return n}(l,n,a,i);return e.asFill&&function(e,t,o,i,r){for(const n of e){const e=n.length;for(let a=1;a<e;++a){const e=n[a-1],l=n[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s),p=Math.floor(c)+1,y=Math.floor(f),h=Math.floor(m)+1;u<i&&(u=i),p>t-i&&(p=t-i),y<i&&(y=i),h>o-i&&(h=o-i);for(let n=y;n<h;++n){if(e[1]>n==l[1]>n)continue;const a=(o-n-1)*t;for(let t=u;t<p;++t)t<(l[0]-e[0])*(n-e[1])/(l[1]-e[1])+e[0]&&(r[a+t]=-r[a+t]);for(let e=i;e<u;++e)r[a+e]=-r[a+e]}}}}(l,n,a,i,s),[T(s,i),n,a]}function T(e,t){const o=2*t,i=e.length,r=new Uint8Array(4*i);for(let t=0;t<i;++t){const i=.5-e[t]/o;p(i,r,4*t)}return r}class G{static executeEffects(e,t,o){const i=h(t);let r=new g(i);for(const t of e){const e=d(t);e&&(r=e.execute(r,t,1.3333333333333333,o))}return r}static next(e){const t=e.next();return y(t),t}static applyEffects(e,i,r){if(!e)return i;let n=new g(i);for(const t of e){const e=d(t);e&&(n=e.execute(n,t,1,r))}let a,l=null;for(;a=n.next();)l?t(l)?t(a)&&l.paths.push(...a.paths):o(l)&&o(a)&&l.rings.push(...a.rings):l=a;return l}}function W(e,t,o,n,a){const l=e.referencesGeometry()&&a?function(e,t,o){const{transform:n,hasZ:a,hasM:l}=o;U.has(t)||U.set(t,function(e){const t={};switch(e){case"esriGeometryPoint":return(e,o,i,r)=>H(o,t,e,i,r);case"esriGeometryPolygon":return(e,o,i,r)=>z(o,t,e,i,r);case"esriGeometryPolyline":return(e,o,i,r)=>X(o,t,e,i,r);case"esriGeometryMultipoint":return(e,o,i,r)=>I(o,t,e,i,r);default:return i.getLogger("esri.views.2d.support.arcadeOnDemand").error(new r("mapview-arcade",`Unable to handle geometryType: ${e}`)),e=>e}}(t));const s=U.get(t)(e.geometry,n,a,l);return{...e,geometry:s}}(t,n,a):t,s=e.repurposeFeature(l);try{return e.evaluate({...o,$feature:s})}catch(e){return i.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",e),null}}const U=new Map;function j(e){const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function D(e){const t=function(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(e)+function(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}(e);return j(e.family)+(t.length>0?t:"-regular")}const q=i.getLogger("esri.symbols.cim.cimAnalyzer");function B(e){switch(e){case"Butt":return w.BUTT;case"Square":return w.SQUARE;default:return w.ROUND}}function K(e){switch(e){case"Bevel":return L.BEVEL;case"Miter":return L.MITER;default:return L.ROUND}}function V(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function _(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function Q(e,t,o,i){let r;e[t]?r=e[t]:(r={},e[t]=r),r[o]=i}function Z(e){const t=e.markerPlacement;return t&&t.angleToLine?P.MAP:P.SCREEN}async function ee(e,t,o,i,r){const a=null!=i?i:[];if(!e)return a;let l,s;const c={};if("CIMSymbolReference"!==e.type)return q.error("Expect cim type to be 'CIMSymbolReference'"),a;if(l=e.symbol,s=e.primitiveOverrides,s){const e=[];for(const o of s){const i=o.valueExpressionInfo;if(i&&t){const r=i.expression,a=n(r,t.spatialReference,t.fields).then((e=>{e&&Q(c,o.primitiveName,o.propertyName,e)}));e.push(a)}else null!=o.value&&Q(c,o.primitiveName,o.propertyName,o.value)}e.length>0&&await Promise.all(e)}const f=[];switch(Ce(l,o,f),f.length>0&&await Promise.all(f),l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":!function(e,t,o,i,r,n,a){if(!e)return;const l=e.symbolLayers;if(!l)return;const s=e.effects;let c;const f=S.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(c=P.MAP);let m=l.length;for(;m--;){const u=l[m];if(!u||!1===u.enable)continue;let p;s&&s.length&&(p=[...s]);const y=u.effects;y&&y.length&&(s?p.push(...y):p=[...y]);const h=[];let g;v.findEffectOverrides(p,t,h),g=h.length>0?de(p,h,o,i):p;const d=[];switch(v.findApplicableOverrides(u,t,d),u.type){case"CIMSolidFill":te(u,g,o,d,i,r);break;case"CIMPictureFill":oe(u,g,o,d,i,n,r);break;case"CIMHatchFill":ie(u,g,o,d,i,r);break;case"CIMGradientFill":re(u,g,o,d,i,r);break;case"CIMSolidStroke":ne(u,g,o,d,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMPictureStroke":ae(u,g,o,d,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMGradientStroke":le(u,g,o,d,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMCharacterMarker":if(se(u,g,o,d,i,r))break;break;case"CIMPictureMarker":if(se(u,g,o,d,i,r))break;"CIMLineSymbol"===e.type&&(c=Z(u)),ce(u,g,o,d,i,n,r,c,f);break;case"CIMVectorMarker":if(se(u,g,o,d,i,r))break;"CIMLineSymbol"===e.type&&(c=Z(u)),fe(u,g,o,d,i,r,n,c,f,a);break;default:q.error("Cannot analyze CIM layer",u.type)}}}(l,s,c,t,a,o,r)}return a}function te(e,t,o,i,r,n){const a=e.primitiveName,s=b(e.color),[c,f]=Ne(i,a,t,null),m=l(JSON.stringify(e)+f).toString();n.push({type:"fill",templateHash:m,materialHash:c?()=>m:m,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:ge(a,o,"Color",r,s,he),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t})}function oe(e,t,o,i,r,n,a){const c=e.primitiveName,f=e.tintColor?b(e.tintColor):{r:255,g:255,b:255,a:1},[m,u]=Ne(i,c,t,null),p=l(JSON.stringify(e)+u).toString(),y=l(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let h=N(e.scaleX);if("width"in e){const t=e.width;let o=1;const i=n.getResource(e.url);s(i)&&(o=i.width/i.height),h/=o*(e.height/t)}a.push({type:"fill",templateHash:p,materialHash:m?()=>y:y,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:ge(c,o,"TintColor",r,f,he),height:ge(c,o,"Height",r,e.height),scaleX:ge(c,o,"ScaleX",r,h),angle:ge(c,o,"Rotation",r,N(e.rotation)),offsetX:ge(c,o,"OffsetX",r,N(e.offsetX)),offsetY:ge(c,o,"OffsetY",r,N(e.offsetY)),url:e.url})}function ie(e,t,o,i,r,n){const a=["Rotation","OffsetX","OffsetY"],s=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===a.indexOf(t.propertyName))),c=e.primitiveName,[f,m]=Ne(i,c,t,null),u=l(JSON.stringify(e)+m).toString(),p=l(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();n.push({type:"fill",templateHash:u,materialHash:f?ve(p,o,s,r):p,cim:e,materialOverrides:s,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:ge(c,o,"Separation",r,e.separation),scaleX:1,angle:ge(c,o,"Rotation",r,N(e.rotation)),offsetX:ge(c,o,"OffsetX",r,N(e.offsetX)),offsetY:ge(c,o,"OffsetY",r,N(e.offsetY))})}function re(e,t,o,i,r,n){const a=e.primitiveName,[s,c]=Ne(i,a,t,null),f=l(JSON.stringify(e)+c).toString();n.push({type:"fill",templateHash:f,materialHash:s?ve(f,o,i,r):f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function ne(e,t,o,i,r,n,a,s){const c=e.primitiveName,f=b(e.color),m=void 0!==e.width?e.width:4,u=B(e.capStyle),p=K(e.joinStyle),y=e.miterLimit,[h,g]=Ne(i,c,t,null),d=l(JSON.stringify(e)+g).toString();let S,v;if(t&&t instanceof Array&&t.length>0){const e=t[t.length-1];if("CIMGeometricEffectDashes"===e.type&&"NoConstraint"===e.lineDashEnding&&null===e.offsetAlongLine){const e=(t=[...t]).pop();S=e.dashTemplate,v=e.scaleDash}}n.push({type:"line",templateHash:d,materialHash:h?()=>d:d,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:t,color:ge(c,o,"Color",r,f,he),width:ge(c,o,"Width",r,m),cap:ge(c,o,"CapStyle",r,u),join:ge(c,o,"JoinStyle",r,p),miterLimit:ge(c,o,"MiterLimit",r,y),referenceWidth:s,zOrder:ye(e.name),dashTemplate:S,scaleDash:v})}function ae(e,t,o,i,r,n,a,s){const c=l(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),f=e.primitiveName,m=b(e.tintColor),u=void 0!==e.width?e.width:4,p=B(e.capStyle),y=K(e.joinStyle),h=e.miterLimit,[g,d]=Ne(i,f,t,null),S=l(JSON.stringify(e)+d).toString();n.push({type:"line",templateHash:S,materialHash:g?()=>c:c,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:t,color:ge(f,o,"TintColor",r,m,he),width:ge(f,o,"Width",r,u),cap:ge(f,o,"CapStyle",r,p),join:ge(f,o,"JoinStyle",r,y),miterLimit:ge(f,o,"MiterLimit",r,h),referenceWidth:s,zOrder:ye(e.name),dashTemplate:null,scaleDash:!1,url:e.url})}function le(e,t,o,i,r,n,a,s){const c=e.primitiveName,f=void 0!==e.width?e.width:4,m=B(e.capStyle),u=K(e.joinStyle),p=e.miterLimit,[y,h]=Ne(i,c,t,null),g=l(JSON.stringify(e)+h).toString();n.push({type:"line",templateHash:g,materialHash:y?ve(g,o,i,r):g,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:ge(c,o,"Width",r,f),cap:ge(c,o,"CapStyle",r,m),join:ge(c,o,"JoinStyle",r,u),miterLimit:ge(c,o,"MiterLimit",r,p),referenceWidth:s,zOrder:ye(e.name),dashTemplate:null,scaleDash:!1})}function se(e,t,o,i,r,n){const a=e.markerPlacement;if(!a||"CIMMarkerPlacementInsidePolygon"!==a.type)return!1;const s=a,c=["Rotation","OffsetX","OffsetY"],f=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===c.indexOf(t.propertyName))),m="url"in e?e.url:null,[u,p]=Ne(i,s.primitiveName,t,null),y=l(JSON.stringify(e)+p).toString();let h=s.stepY,g=null,d=1;return a.shiftOddRows&&(h*=2,g=function(e){return e?2*e:0},d=.5),n.push({type:"fill",templateHash:y,materialHash:u?ve(y,o,f,r):y,cim:e,materialOverrides:f,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:ge(s.primitiveName,o,"StepY",r,h,g),scaleX:d,angle:ge(s.primitiveName,o,"GridAngle",r,s.gridAngle),offsetX:ge(s.primitiveName,o,"OffsetX",r,N(s.offsetX)),offsetY:ge(s.primitiveName,o,"OffsetY",r,N(s.offsetY)),url:m}),!0}function ce(e,t,o,i,r,n,a,c,f){var m;const u=e.primitiveName,p=N(e.size);let y=N(e.scaleX);const h=N(e.rotation),g=N(e.offsetX),d=N(e.offsetY),S=e.tintColor?b(e.tintColor):{r:255,g:255,b:255,a:1},v=l(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),C=Se(e.markerPlacement,i,o,r),[k,O]=Ne(i,u,t,C),M=l(JSON.stringify(e)+O).toString(),x=null!=(m=e.anchorPoint)?m:{x:0,y:0};if("width"in e){const t=e.width;let o=1;const i=n.getResource(e.url);s(i)&&(o=i.width/i.height),y/=o*(p/t)}a.push({type:"marker",templateHash:M,materialHash:k?()=>v:v,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:!1,alignment:c,size:ge(u,o,"Size",r,p),scaleX:ge(u,o,"ScaleX",r,y),rotation:ge(u,o,"Rotation",r,h),offsetX:ge(u,o,"OffsetX",r,g),offsetY:ge(u,o,"OffsetY",r,d),color:ge(u,o,"TintColor",r,S,he),anchorPoint:{x:x.x,y:-x.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:f,sizeRatio:1,markerPlacement:e.markerPlacement,url:e.url})}function fe(e,t,o,i,r,n,a,l,s,c){const f=e.markerGraphics;if(!f)return;let m=0;if(e.scaleSymbolsProportionally){const t=e.frame;t&&(m=t.ymax-t.ymin)}const u=Se(e.markerPlacement,i,o,r);for(const p of f)if(p){const f=p.symbol;if(!f)continue;switch(f.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":ue(e,t,u,p,i,o,r,n,a,l,s,m,c);break;case"CIMTextSymbol":me(e,t,u,p,o,i,r,n,l,s,m)}}}function me(e,t,o,i,r,n,a,s,c,f,m){v.findApplicableOverrides(i,n,[]);const u=i.geometry;if(!("x"in u)||!("y"in u))return;const p=i.symbol,y=function(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}(p),h=function(e){let t="",o="";if(e){const i=e.toLowerCase();-1!==i.indexOf("italic")?t="italic":-1!==i.indexOf("oblique")&&(t="oblique"),-1!==i.indexOf("bold")?o="bold":-1!==i.indexOf("light")&&(o="lighter")}return{style:t,weight:o}}(p.fontStyleName),g=j(p.fontFamilyName);p.font={family:g,decoration:y,...h};const d=e.frame,M=u.x-.5*(d.xmin+d.xmax),x=u.y-.5*(d.ymin+d.ymax),P=e.size/m,w=e.primitiveName,L=N(p.height)*P,I=N(p.angle),X=N(e.offsetX)+(N(p.offsetX)+M)*P,z=N(e.offsetY)+(N(p.offsetY)+x)*P,H=b(S.getFillColor(p));let J=b(S.getStrokeColor(p)),R=S.getStrokeWidth(p);R||(J=b(S.getFillColor(p.haloSymbol)),R=p.haloSize*P);const[A,Y]=Ne(n,w,t,o),F=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),E=l(JSON.stringify(i)+F+Y).toString();let $=ge(i.primitiveName,r,"TextString",a,i.textString,C,p.textCase);if(null==$)return;const{fontStyleName:T}=p,G=g+(T?"-"+T.toLowerCase():"-regular"),W=G;"string"==typeof $&&$.indexOf("[")>-1&&p.fieldMap&&($=k(p.fieldMap,$,p.textCase)),s.push({type:"text",templateHash:E,materialHash:A||"function"==typeof $||$.match(/\[(.*?)\]/)?(e,t,o)=>W+"-"+O($,e,t,o):W+"-"+l($),cim:p,materialOverrides:null,colorLocked:e.colorLocked,effects:t,alignment:c,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:G,decoration:y,weight:ge(w,r,"Weight",a,h.weight),style:ge(w,r,"Size",a,h.style),size:ge(w,r,"Size",a,L),angle:ge(w,r,"Rotation",a,I),offsetX:ge(w,r,"OffsetX",a,X),offsetY:ge(w,r,"OffsetY",a,z),horizontalAlignment:V(p.horizontalAlignment),verticalAlignment:_(p.verticalAlignment),text:$,color:H,outlineColor:J,outlineSize:R,referenceSize:f,sizeRatio:1,markerPlacement:o})}function ue(e,t,o,i,r,n,a,c,f,m,u,p,y){const h=i.symbol,g=h.symbolLayers;if(!g)return;if(y)return void pe(e,t,o,i,n,r,a,c,f,m,u,p);let d=g.length;if(ke(g))return void function(e,t,o,i,r,n,a,s,c,f,m,u){const p=i.geometry,y=r[0],h=r[1],g=F(p);if(!g)return;const[d,v,C]=E(g,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),k={type:"sdf",geom:p,asFill:!0},O=e.primitiveName,M=N(e.size),x=N(e.rotation),P=N(e.offsetX),w=N(e.offsetY),L=h.path,I=h.primitiveName,X=y.primitiveName,z=b(S.getFillColor(h)),H=b(S.getStrokeColor(y)),J=S.getStrokeWidth(y);let R=!1,A="";for(const e of n)e.primitiveName!==I&&e.primitiveName!==X&&e.primitiveName!==O||(void 0!==e.value?A+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(R=!0));const Y=JSON.stringify({...e,markerGraphics:null}),$=l(JSON.stringify(k)+L).toString(),T={type:"marker",templateHash:l(JSON.stringify(i)+JSON.stringify(h)+JSON.stringify(y)+Y+A).toString(),materialHash:R?()=>$:$,cim:k,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:v,y:C},isAbsoluteAnchorPoint:!1,size:ge(e.primitiveName,a,"Size",s,M),rotation:ge(e.primitiveName,a,"Rotation",s,x),offsetX:ge(e.primitiveName,a,"OffsetX",s,P),offsetY:ge(e.primitiveName,a,"OffsetY",s,w),scaleX:1,frameHeight:u,rotateClockwise:e.rotateClockwise,referenceSize:m,sizeRatio:d,color:ge(I,a,"Color",s,z,he),outlineColor:ge(X,a,"Color",s,H,he),outlineWidth:ge(X,a,"Width",s,J),markerPlacement:o,path:L};c.push(T)}(e,t,o,i,g,r,n,a,c,m,u,p);const v=G.applyEffects(h.effects,i.geometry,f.geometryEngine);if(v)for(;d--;){const y=g[d];if(y&&!1!==y.enable)switch(y.type){case"CIMSolidFill":case"CIMSolidStroke":{var C;const h=G.applyEffects(y.effects,v,f.geometryEngine),g=F(h);if(!g)continue;const[d,k,O]=E(g,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),M="CIMSolidFill"===y.type,x={type:"sdf",geom:h,asFill:M},P=e.primitiveName,w=null!=(C=N(e.size))?C:10,L=N(e.rotation),I=N(e.offsetX),X=N(e.offsetY),z=y.path,H=y.primitiveName,J=b(M?S.getFillColor(y):S.getStrokeColor(y)),R=M?{r:0,g:0,b:0,a:0}:b(S.getStrokeColor(y)),A=S.getStrokeWidth(y);if(!M&&!A)break;let Y=!1,$="";for(const e of r)e.primitiveName!==H&&e.primitiveName!==P||(void 0!==e.value?$+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(Y=!0));s(t)&&"function"==typeof t&&(Y=!0);const T=JSON.stringify({...e,markerGraphics:null}),W=l(JSON.stringify(x)+z).toString(),U={type:"marker",templateHash:l(JSON.stringify(i)+JSON.stringify(y)+T+$).toString(),materialHash:Y?()=>W:W,cim:x,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:m,anchorPoint:{x:k,y:O},isAbsoluteAnchorPoint:!1,size:ge(e.primitiveName,n,"Size",a,w),rotation:ge(e.primitiveName,n,"Rotation",a,L),offsetX:ge(e.primitiveName,n,"OffsetX",a,I),offsetY:ge(e.primitiveName,n,"OffsetY",a,X),scaleX:1,frameHeight:p,rotateClockwise:e.rotateClockwise,referenceSize:u,sizeRatio:d,color:ge(H,n,"Color",a,J,he),outlineColor:ge(H,n,"Color",a,R,he),outlineWidth:ge(H,n,"Width",a,A),markerPlacement:o,path:z};c.push(U);break}default:pe(e,t,o,i,n,r,a,c,f,m,u,p)}}}function pe(e,t,o,i,r,n,a,f,m,u,p,y){const h=function(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}(e,i);let g=[];const d=["Rotation","OffsetX","OffsetY"];g=n.filter((t=>t.primitiveName!==e.primitiveName||-1===d.indexOf(t.propertyName)));let v="";for(const e of n)void 0!==e.value&&(v+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`);const[b,C,k]=S.getTextureAnchor(h,m),O=e.primitiveName,M=N(e.rotation),x=N(e.offsetX),P=N(e.offsetY),w=l(JSON.stringify(h)+v).toString(),L={type:"marker",templateHash:w,materialHash:g.length>0||s(t)&&"function"==typeof t?ve(w,r,g,a):w,cim:h,materialOverrides:g,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:u,anchorPoint:{x:b,y:C},isAbsoluteAnchorPoint:!1,size:e.size,rotation:ge(O,r,"Rotation",a,M),offsetX:ge(O,r,"OffsetX",a,x),offsetY:ge(O,r,"OffsetY",a,P),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:y,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:k/c(e.size),markerPlacement:o};f.push(L)}function ye(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function he(e){if(!e||0===e.length)return null;const t=new m(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function ge(e,t,o,i,r,n,a){const l=t[e];if(l){const e=l[o];if("string"==typeof e||"number"==typeof e||e instanceof Array)return n?n.call(null,e,a):e;if(null!=e&&e instanceof f)return(t,o,l)=>{let s=W(e,t,{$view:l},i.geometryType,o);return null!==s&&n&&(s=n.call(null,s,a)),null!==s?s:r}}return r}function de(e,t,o,i){for(const e of t)if(e.valueExpressionInfo){const t=o[e.primitiveName]&&o[e.primitiveName][e.propertyName];t instanceof f&&(e.fn=(e,o,r)=>W(t,e,{$view:r},i.geometryType,o))}const r=e=>e?e.charAt(0).toLowerCase()+e.substr(1):e;return(o,i,n)=>{for(const e of t)e.fn&&(e.value=e.fn(o,i,n));const l=[];for(let o of e){var s;const e=null==(s=o)?void 0:s.primitiveName;if(e){let i=!1;for(const n of t)if(n.primitiveName===e){const e=r(n.propertyName);null!=n.value&&n.value!==o[e]&&(i||(o=a(o),i=!0),o[e]=n.value)}}l.push(o)}return l}}function Se(e,t,o,i){const r=[];if(v.findApplicableOverrides(e,t,r),0===r.length)return e;for(const e of r)if(e.valueExpressionInfo){const t=o[e.primitiveName]&&o[e.primitiveName][e.propertyName];t instanceof f&&(e.fn=(e,o,r)=>W(t,e,{$view:r},i.geometryType,o))}const n=e=>e?e.charAt(0).toLowerCase()+e.substr(1):e;return(t,o,i)=>{for(const e of r)e.fn&&(e.value=e.fn(t,o,i));const l=a(e),s=e.primitiveName;for(const e of r)if(e.primitiveName===s){const t=n(e.propertyName);null!=e.value&&e.value!==l[t]&&(l[t]=e.value)}return l}}function ve(e,t,o,i){for(const e of o)if(e.valueExpressionInfo){const o=t[e.primitiveName]&&t[e.primitiveName][e.propertyName];o instanceof f&&(e.fn=(e,t,r)=>W(o,e,{$view:r},i.geometryType,t))}return(t,i,r)=>{for(const e of o)e.fn&&(e.value=e.fn(t,i,r));return l(e+v.buildOverrideKey(o)).toString()}}function be(e,t){if(!t||0===t.length)return e;const o=JSON.parse(JSON.stringify(e));return v.applyOverrides(o,t),o}function Ne(e,t,o,i){let r=!1,n="";for(const o of e)o.primitiveName===t&&(void 0!==o.value?n+=`-${o.primitiveName}-${o.propertyName}-${JSON.stringify(o.value)}`:o.valueExpressionInfo&&(r=!0));return s(o)&&"function"==typeof o&&(r=!0),s(i)&&"function"==typeof i&&(r=!0),[r,n]}function Ce(e,t,o){if(e&&t)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const i=e.symbolLayers;if(!i)return;for(const e of i)switch(Me(e,t,o),e.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in e&&e.url&&o.push(t.fetchResource(e.url,null));break;case"CIMVectorMarker":{const i=e.markerGraphics;if(!i)continue;for(const e of i)if(e){const i=e.symbol;i&&Ce(i,t,o)}}}}}}const ke=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&!e[0].effects&&!e[1].effects;let Oe;function Me(e,t,o){e.effects&&!s(t.geometryEngine)&&(Oe?o.push(Oe):M(e.effects)&&(Oe=x(),o.push(Oe),Oe.then((e=>t.geometryEngine=e))))}const xe={marker:J.MARKER,fill:J.FILL,line:J.LINE,text:J.TEXT};class Pe{constructor(e,t,o,i){const r={minScale:null==t?void 0:t.minScale,maxScale:null==t?void 0:t.maxScale},n=function(e){return e.minScale||e.maxScale?e.minScale+"-"+e.maxScale:""}(r);this.layers=e,this.data=t,this.hash=this._createHash()+n,this.rendererKey=o;const a={isOutline:!1,isOutlinedFill:!1,placement:null,stride:{fill:"default"},vvFlags:o};for(const t of e){const e=xe[t.type];t.materialKey=R(e,a),t.maxVVSize=i,t.scaleInfo=r,t.templateHash+=n}}get type(){return"expanded-cim"}_createHash(){let e="";for(const t of this.layers)e+=t.templateHash;return e}}export{ee as H,G as f,Pe as l,$ as m,D as n,be as o,A as r,W as s};
