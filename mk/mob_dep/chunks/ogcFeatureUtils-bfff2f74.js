import{s as e,t,e as n,C as i,go as a,bY as s,aV as r,gN as o,D as l,r as c,bN as d,bu as u,cz as f,eF as m,gO as p}from"../main.js";import{O as g,T as y,L as w}from"./geojson-c3700ba2.js";import{n as b}from"./clientSideDefaults-be1e4608.js";const h=e.getLogger("esri.layers.graphics.sources.ogcfeature"),F="http://www.opengis.net/def/crs/",I=`${F}OGC/1.3/CRS84`;async function j(e,r,o={},l=5){const{links:c}=e,d=D(c,"items","application/geo+json")||D(c,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(t(d))throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{data:u}=await i(d.href,{signal:o.signal,query:{limit:l,...o.customParameters,token:o.apiKey},headers:{accept:"application/geo+json"}});await g(u);const f=y(u,{geometryType:r.geometryType}),m=r.fields||f.fields||[],p=null!=r.hasZ?r.hasZ:f.hasZ,w=f.geometryType,F=r.objectIdField||f.objectIdFieldName||"OBJECTID";let I=r.timeInfo;const j=m.find((e=>e.name===F));if(j)j.type="esriFieldTypeOID",j.editable=!1,j.nullable=!1;else{if(!f.objectIdFieldType)throw new n("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");m.unshift({name:F,alias:F,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(F!==f.objectIdFieldName){const e=m.find((e=>e.name===f.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}m===f.fields&&f.unknownFields.length>0&&h.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:f.unknownFields}});for(const e of m){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new n("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(-1===a.jsonValues.indexOf(e.type))throw new n("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(I){const e=new s(m);if(I.startTimeField){const t=e.get(I.startTimeField);t?(I.startTimeField=t.name,t.type="esriFieldTypeDate"):I.startTimeField=null}if(I.endTimeField){const t=e.get(I.endTimeField);t?(I.endTimeField=t.name,t.type="esriFieldTypeDate"):I.endTimeField=null}if(I.trackIdField){const t=e.get(I.trackIdField);t?I.trackIdField=t.name:(I.trackIdField=null,h.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:I}}))}I.startTimeField||I.endTimeField||(h.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:I}}),I=null)}return{drawingInfo:w?b(w):null,geometryType:w,fields:m,hasZ:!!p,objectIdField:F,timeInfo:I}}async function T(e,a={}){const{links:s}=e,r=D(s,"data","application/json")||D(s,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(t(r))throw new n("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:o,customParameters:l,signal:c}=a,{data:d}=await i(r.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:o}});return d}async function k(e,a={}){const{links:s}=e,r=D(s,"conformance","application/json")||D(s,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(t(r))throw new n("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:o,customParameters:l,signal:c}=a,{data:d}=await i(r.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:o}});return d}async function x(e,t={}){const{apiKey:n,customParameters:a,signal:s}=t,{data:r}=await i(e,{signal:s,headers:{accept:"application/json"},query:{...a,token:n}});return r}async function N(e,n={}){const a="application/vnd.oai.openapi+json;version=3.0",s=D(e.links,"service-desc",a);if(t(s))return h.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:r,customParameters:o,signal:l}=n,{data:c}=await i(s.href,{signal:l,headers:{accept:a},query:{...o,token:r}});return c}function S(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=null==t?void 0:t.groups;if(!n)return null;const{authority:i,code:a}=n;switch(i.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return r.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return r.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(a,10);return Number.isNaN(e)?null:e}default:return null}}async function v(e,t,n){const i=await O(e,t,n);return o(i)}async function O(e,a,s){const{capabilities:{query:{maxRecordCount:o}},collection:g,layerDefinition:y,queryParameters:{apiKey:b,customParameters:h},spatialReference:F,supportedCrs:I}=e,{links:j}=g,T=D(j,"items","application/geo+json")||D(j,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(t(T))throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:k,num:x,start:N,timeExtent:S,where:v}=a;if(a.objectIds)throw new n("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const O=r.fromJSON(F),M=l(a.outSpatialReference,O),$=M.isWGS84?null:q(M,I),G=C(k,I),P=function(e){if(t(e))return null;const{start:n,end:i}=e;return`${c(n)?n.toISOString():".."}/${c(i)?i.toISOString():".."}`}(S),R=function(e){return t(e)||!e||"1=1"===e?null:e}(v),W=null!=x?x:null!=N&&void 0!==N?10:o,{data:Z}=await i(T.href,{...s,query:{...h,...G,crs:$,datetime:P,query:R,limit:W,startindex:N,token:b},headers:{accept:"application/geo+json"}});let K=!1;if(Z.links){K=!!Z.links.find((e=>"next"===e.rel))}!K&&Number.isInteger(Z.numberMatched)&&Number.isInteger(Z.numberReturned)&&(K=Z.numberReturned<Z.numberMatched);const{fields:L,globalIdField:A,hasM:J,hasZ:E,objectIdField:V}=y,_=y.geometryType,z=w(Z,{geometryType:_,hasZ:E,objectIdField:V});if(!$&&M.isWebMercator)for(const e of z)if(c(e.geometry)){const t=d(e.geometry,_,E,!1);t.spatialReference=r.WGS84,e.geometry=u(f(t,M))}for(const e of z)e.objectId=e.attributes[V];const B=$||!$&&M.isWebMercator?M.toJSON():m,Q=new p;return Q.exceededTransferLimit=K,Q.features=z,Q.fields=L,Q.geometryType=_,Q.globalIdFieldName=A,Q.hasM=J,Q.hasZ=E,Q.objectIdFieldName=V,Q.spatialReference=B,Q}function q(e,t){var n,i,a;const{isWebMercator:s,wkid:r}=e;if(!r)return null;const o=s?null!=(n=null!=(i=null!=(a=t[3857])?a:t[102100])?i:t[102113])?n:t[900913]:t[e.wkid];return o?`${F}${o}`:null}function M(e){if(t(e))return"";const{xmin:n,ymin:i,xmax:a,ymax:s}=e;return`${n},${i},${a},${s}`}function C(e,t){if(!function(e){return c(e)&&"extent"===e.type}(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:M(e)};const i=q(n,t);return c(i)?{bbox:M(e),"bbox-crs":i}:n.isWebMercator?{bbox:M(f(e,r.WGS84))}:null}function D(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}export{I as F,j as I,v as N,N as S,T,F as j,k,O as q,S as v,x};
