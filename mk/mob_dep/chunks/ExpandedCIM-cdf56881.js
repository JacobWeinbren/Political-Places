import{at as e,av as t,au as o,s as i,e as r,c6 as n,c7 as a,c8 as l,c9 as s,bI as c,b5 as f,ca as m,r as u,x as p,cb as y,bg as h}from"../main.js";import{t as g,o as d,x as S,c as v,f as b,A as N,$ as C,K as k,i as O,M,h as x,k as P,e as w,p as L,C as I}from"./CIMSymbolHelper-79eed166.js";import{q as X,k as z,m as H}from"./enums-873d3e5a.js";import{b as J}from"./Utils-4efd2b2d.js";import{L as R}from"./MaterialKey-37656b1a.js";function A(e){if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&1===t.length?A(t[0]):null}case"CIMVectorMarker":{var t;const o=e.markerGraphics;if(!o||1!==o.length)return null;const i=o[0];if(!i)return null;const r=i.geometry;if(!r)return null;const n=i.symbol;return!n||"CIMPolygonSymbol"!==n.type&&"CIMLineSymbol"!==n.type||null!=(t=n.symbolLayers)&&t.some((e=>!!e.effects))?null:{geom:r,asFill:"CIMPolygonSymbol"===n.type}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function Y(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return[t,i,o,r]}function F(t){return t?t.rings?Y(t.rings):t.paths?Y(t.paths):e(t)?[t.xmin,t.ymin,t.xmax,t.ymax]:null:null}function E(e,t,o,i,r){const[n,a,l,s]=e;if(l<n||s<a)return[0,0,0];const c=l-n,f=s-a,m=Math.floor(31.5),u=(128-2*(m+1))/Math.max(c,f),p=Math.round(c*u)+2*m,y=Math.round(f*u)+2*m;let h=1;t&&(h=y/u/(t.ymax-t.ymin));let g=0,d=0;if(i)if(r){if(t&&o&&t.ymax-t.ymin>0){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin);g=i.x/(o*e),d=i.y/o}}else g=i.x,d=i.y;return g=.5*(t.xmax+t.xmin)+g*(t.xmax-t.xmin),d=.5*(t.ymax+t.ymin)+d*(t.ymax-t.ymin),g-=n,d-=a,g*=u,d*=u,g+=m,d+=m,[h,g/p-.5,-(d/y-.5)]}function $(e){const t=function(e){return e?e.rings?e.rings:e.paths?e.paths:void 0!==e.xmin&&void 0!==e.ymin&&void 0!==e.xmax&&void 0!==e.ymax?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]:null:null}(e.geom),o=function(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return new g(t,i,o-t,r-i)}(t),i=Math.floor(31.5),r=(128-2*(i+1))/Math.max(o.width,o.height),n=Math.round(o.width*r)+2*i,a=Math.round(o.height*r)+2*i,l=[];for(const n of t)if(n&&n.length>1){const t=[];for(const a of n){let[n,l]=a;n-=o.x,l-=o.y,n*=r,l*=r,n+=i-.5,l+=i-.5,e.asFill?t.push([n,l]):t.push([Math.round(n),Math.round(l)])}if(e.asFill){const e=t.length-1;t[0][0]===t[e][0]&&t[0][1]===t[e][1]||t.push(t[0])}l.push(t)}const s=function(e,t,o,i){const r=t*o,n=new Array(r),a=i*i+1;for(let e=0;e<r;++e)n[e]=a;for(const r of e){const e=r.length;for(let a=1;a<e;++a){const e=r[a-1],l=r[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s)-i,p=Math.floor(c)+i,y=Math.floor(f)-i,h=Math.floor(m)+i;u<0&&(u=0),p>t&&(p=t),y<0&&(y=0),h>o&&(h=o);const g=l[0]-e[0],d=l[1]-e[1],S=g*g+d*d;for(let i=u;i<p;i++)for(let r=y;r<h;r++){let a,s,c=(i-e[0])*g+(r-e[1])*d;c<0?(a=e[0],s=e[1]):c>S?(a=l[0],s=l[1]):(c/=S,a=e[0]+c*g,s=e[1]+c*d);const f=(i-a)*(i-a)+(r-s)*(r-s),m=(o-r-1)*t+i;f<n[m]&&(n[m]=f)}}}for(let e=0;e<r;++e)n[e]=Math.sqrt(n[e]);return n}(l,n,a,i);return e.asFill&&function(e,t,o,i,r){for(const n of e){const e=n.length;for(let a=1;a<e;++a){const e=n[a-1],l=n[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s),p=Math.floor(c)+1,y=Math.floor(f),h=Math.floor(m)+1;u<i&&(u=i),p>t-i&&(p=t-i),y<i&&(y=i),h>o-i&&(h=o-i);for(let n=y;n<h;++n){if(e[1]>n==l[1]>n)continue;const a=(o-n-1)*t;for(let t=u;t<p;++t)t<(l[0]-e[0])*(n-e[1])/(l[1]-e[1])+e[0]&&(r[a+t]=-r[a+t]);for(let e=i;e<u;++e)r[a+e]=-r[a+e]}}}}(l,n,a,i,s),[T(s,i),n,a]}function T(e,t){const o=2*t,i=e.length,r=new Uint8Array(4*i);for(let t=0;t<i;++t){const i=.5-e[t]/o;d(i,r,4*t)}return r}class G{static executeEffects(e,t,o){const i=v(t);let r=new b(i);for(const t of e){const e=N(t);e&&(r=e.execute(r,t,1.3333333333333333,o))}return r}static next(e){const t=e.next();return S(t),t}static applyEffects(e,i,r){if(!e)return i;let n=new b(i);for(const t of e){const e=N(t);e&&(n=e.execute(n,t,1,r))}let a,l=null;for(;a=n.next();)l?t(l)?t(a)&&l.paths.push(...a.paths):o(l)&&o(a)&&l.rings.push(...a.rings):l=a;return l}}function W(e,t,o,c,f){const m=e.referencesGeometry()&&f?function(e,t,o){const{transform:c,hasZ:f,hasM:m}=o;D.has(t)||D.set(t,function(e){const t={};switch(e){case"esriGeometryPoint":return(e,o,i,r)=>s(o,t,e,i,r);case"esriGeometryPolygon":return(e,o,i,r)=>l(o,t,e,i,r);case"esriGeometryPolyline":return(e,o,i,r)=>a(o,t,e,i,r);case"esriGeometryMultipoint":return(e,o,i,r)=>n(o,t,e,i,r);default:return i.getLogger("esri.views.2d.support.arcadeOnDemand").error(new r("mapview-arcade",`Unable to handle geometryType: ${e}`)),e=>e}}(t));const u=D.get(t)(e.geometry,c,f,m);return{...e,geometry:u}}(t,c,f):t,u=e.repurposeFeature(m);try{return e.evaluate({...o,$feature:u})}catch(e){return i.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",e),null}}const D=new Map;function U(e){const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function j(e){const t=function(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(e)+function(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}(e);return U(e.family)+(t.length>0?t:"-regular")}const q=i.getLogger("esri.symbols.cim.cimAnalyzer");function B(e){switch(e){case"Butt":return z.BUTT;case"Square":return z.SQUARE;default:return z.ROUND}}function K(e){switch(e){case"Bevel":return H.BEVEL;case"Miter":return H.MITER;default:return H.ROUND}}function V(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function _(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function Q(e,t,o,i){let r;e[t]?r=e[t]:(r={},e[t]=r),r[o]=i}function Z(e){const t=e.markerPlacement;return t&&t.angleToLine?X.MAP:X.SCREEN}async function ee(e,t,o,i,r){const n=null!=i?i:[];if(!e)return n;let a,l;const s={};if("CIMSymbolReference"!==e.type)return q.error("Expect cim type to be 'CIMSymbolReference'"),n;if(a=e.symbol,l=e.primitiveOverrides,l){const e=[];for(const o of l){const i=o.valueExpressionInfo;if(i&&t){const r=i.expression,n=c(r,t.spatialReference,t.fields).then((e=>{e&&Q(s,o.primitiveName,o.propertyName,e)}));e.push(n)}else null!=o.value&&Q(s,o.primitiveName,o.propertyName,o.value)}e.length>0&&await Promise.all(e)}const f=[];switch(Ce(a,o,f),f.length>0&&await Promise.all(f),a.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":!function(e,t,o,i,r,n,a){if(!e)return;const l=e.symbolLayers;if(!l)return;const s=e.effects;let c;const f=C.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(c=X.MAP);let m=l.length;for(;m--;){const u=l[m];if(!u||!1===u.enable)continue;let p;s&&s.length&&(p=[...s]);const y=u.effects;y&&y.length&&(s?p.push(...y):p=[...y]);const h=[];let g;k.findEffectOverrides(p,t,h),g=h.length>0?de(p,h,o,i):p;const d=[];switch(k.findApplicableOverrides(u,t,d),u.type){case"CIMSolidFill":te(u,g,o,d,i,r);break;case"CIMPictureFill":oe(u,g,o,d,i,n,r);break;case"CIMHatchFill":ie(u,g,o,d,i,r);break;case"CIMGradientFill":re(u,g,o,d,i,r);break;case"CIMSolidStroke":ne(u,g,o,d,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMPictureStroke":ae(u,g,o,d,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMGradientStroke":le(u,g,o,d,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMCharacterMarker":if(se(u,g,o,d,i,r))break;break;case"CIMPictureMarker":if(se(u,g,o,d,i,r))break;"CIMLineSymbol"===e.type&&(c=Z(u)),ce(u,g,o,d,i,n,r,c,f);break;case"CIMVectorMarker":if(se(u,g,o,d,i,r))break;"CIMLineSymbol"===e.type&&(c=Z(u)),fe(u,g,o,d,i,r,n,c,f,a);break;default:q.error("Cannot analyze CIM layer",u.type)}}}(a,l,s,t,n,o,r)}return n}function te(e,t,o,i,r,n){const a=e.primitiveName,l=O(e.color),[s,c]=Ne(i,a,t,null),f=m(JSON.stringify(e)+c).toString();n.push({type:"fill",templateHash:f,materialHash:s?()=>f:f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:ge(a,o,"Color",r,l,he),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t})}function oe(e,t,o,i,r,n,a){const l=e.primitiveName,s=e.tintColor?O(e.tintColor):{r:255,g:255,b:255,a:1},[c,f]=Ne(i,l,t,null),p=m(JSON.stringify(e)+f).toString(),y=m(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let h=M(e.scaleX);if("width"in e){const t=e.width;let o=1;const i=n.getResource(e.url);u(i)&&(o=i.width/i.height),h/=o*(e.height/t)}a.push({type:"fill",templateHash:p,materialHash:c?()=>y:y,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:ge(l,o,"TintColor",r,s,he),height:ge(l,o,"Height",r,e.height),scaleX:ge(l,o,"ScaleX",r,h),angle:ge(l,o,"Rotation",r,M(e.rotation)),offsetX:ge(l,o,"OffsetX",r,M(e.offsetX)),offsetY:ge(l,o,"OffsetY",r,M(e.offsetY)),url:e.url})}function ie(e,t,o,i,r,n){const a=["Rotation","OffsetX","OffsetY"],l=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===a.indexOf(t.propertyName))),s=e.primitiveName,[c,f]=Ne(i,s,t,null),u=m(JSON.stringify(e)+f).toString(),p=m(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();n.push({type:"fill",templateHash:u,materialHash:c?ve(p,o,l,r):p,cim:e,materialOverrides:l,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:ge(s,o,"Separation",r,e.separation),scaleX:1,angle:ge(s,o,"Rotation",r,M(e.rotation)),offsetX:ge(s,o,"OffsetX",r,M(e.offsetX)),offsetY:ge(s,o,"OffsetY",r,M(e.offsetY))})}function re(e,t,o,i,r,n){const a=e.primitiveName,[l,s]=Ne(i,a,t,null),c=m(JSON.stringify(e)+s).toString();n.push({type:"fill",templateHash:c,materialHash:l?ve(c,o,i,r):c,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function ne(e,t,o,i,r,n,a,l){const s=e.primitiveName,c=O(e.color),f=void 0!==e.width?e.width:4,u=B(e.capStyle),p=K(e.joinStyle),y=e.miterLimit,[h,g]=Ne(i,s,t,null),d=m(JSON.stringify(e)+g).toString();let S,v;if(t&&t instanceof Array&&t.length>0){const e=t[t.length-1];if("CIMGeometricEffectDashes"===e.type&&"NoConstraint"===e.lineDashEnding&&null===e.offsetAlongLine){const e=(t=[...t]).pop();S=e.dashTemplate,v=e.scaleDash}}n.push({type:"line",templateHash:d,materialHash:h?()=>d:d,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:t,color:ge(s,o,"Color",r,c,he),width:ge(s,o,"Width",r,f),cap:ge(s,o,"CapStyle",r,u),join:ge(s,o,"JoinStyle",r,p),miterLimit:ge(s,o,"MiterLimit",r,y),referenceWidth:l,zOrder:ye(e.name),dashTemplate:S,scaleDash:v})}function ae(e,t,o,i,r,n,a,l){const s=m(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),c=e.primitiveName,f=O(e.tintColor),u=void 0!==e.width?e.width:4,p=B(e.capStyle),y=K(e.joinStyle),h=e.miterLimit,[g,d]=Ne(i,c,t,null),S=m(JSON.stringify(e)+d).toString();n.push({type:"line",templateHash:S,materialHash:g?()=>s:s,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:t,color:ge(c,o,"TintColor",r,f,he),width:ge(c,o,"Width",r,u),cap:ge(c,o,"CapStyle",r,p),join:ge(c,o,"JoinStyle",r,y),miterLimit:ge(c,o,"MiterLimit",r,h),referenceWidth:l,zOrder:ye(e.name),dashTemplate:null,scaleDash:!1,url:e.url})}function le(e,t,o,i,r,n,a,l){const s=e.primitiveName,c=void 0!==e.width?e.width:4,f=B(e.capStyle),u=K(e.joinStyle),p=e.miterLimit,[y,h]=Ne(i,s,t,null),g=m(JSON.stringify(e)+h).toString();n.push({type:"line",templateHash:g,materialHash:y?ve(g,o,i,r):g,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:ge(s,o,"Width",r,c),cap:ge(s,o,"CapStyle",r,f),join:ge(s,o,"JoinStyle",r,u),miterLimit:ge(s,o,"MiterLimit",r,p),referenceWidth:l,zOrder:ye(e.name),dashTemplate:null,scaleDash:!1})}function se(e,t,o,i,r,n){const a=e.markerPlacement;if(!a||"CIMMarkerPlacementInsidePolygon"!==a.type)return!1;const l=a,s=["Rotation","OffsetX","OffsetY"],c=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===s.indexOf(t.propertyName))),f="url"in e?e.url:null,[u,p]=Ne(i,l.primitiveName,t,null),y=m(JSON.stringify(e)+p).toString();let h=l.stepY,g=null,d=1;return a.shiftOddRows&&(h*=2,g=function(e){return e?2*e:0},d=.5),n.push({type:"fill",templateHash:y,materialHash:u?ve(y,o,c,r):y,cim:e,materialOverrides:c,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:ge(l.primitiveName,o,"StepY",r,h,g),scaleX:d,angle:ge(l.primitiveName,o,"GridAngle",r,l.gridAngle),offsetX:ge(l.primitiveName,o,"OffsetX",r,M(l.offsetX)),offsetY:ge(l.primitiveName,o,"OffsetY",r,M(l.offsetY)),url:f}),!0}function ce(e,t,o,i,r,n,a,l,s){var c;const f=e.primitiveName,p=M(e.size);let y=M(e.scaleX);const h=M(e.rotation),g=M(e.offsetX),d=M(e.offsetY),S=e.tintColor?O(e.tintColor):{r:255,g:255,b:255,a:1},v=m(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),b=Se(e.markerPlacement,i,o,r),[N,C]=Ne(i,f,t,b),k=m(JSON.stringify(e)+C).toString(),x=null!=(c=e.anchorPoint)?c:{x:0,y:0};if("width"in e){const t=e.width;let o=1;const i=n.getResource(e.url);u(i)&&(o=i.width/i.height),y/=o*(p/t)}a.push({type:"marker",templateHash:k,materialHash:N?()=>v:v,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:!1,alignment:l,size:ge(f,o,"Size",r,p),scaleX:ge(f,o,"ScaleX",r,y),rotation:ge(f,o,"Rotation",r,h),offsetX:ge(f,o,"OffsetX",r,g),offsetY:ge(f,o,"OffsetY",r,d),color:ge(f,o,"TintColor",r,S,he),anchorPoint:{x:x.x,y:-x.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:s,sizeRatio:1,markerPlacement:e.markerPlacement,url:e.url})}function fe(e,t,o,i,r,n,a,l,s,c){const f=e.markerGraphics;if(!f)return;let m=0;if(e.scaleSymbolsProportionally){const t=e.frame;t&&(m=t.ymax-t.ymin)}const u=Se(e.markerPlacement,i,o,r);for(const p of f)if(p){const f=p.symbol;if(!f)continue;switch(f.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":ue(e,t,u,p,i,o,r,n,a,l,s,m,c);break;case"CIMTextSymbol":me(e,t,u,p,o,i,r,n,l,s,m)}}}function me(e,t,o,i,r,n,a,l,s,c,f){k.findApplicableOverrides(i,n,[]);const u=i.geometry;if(!("x"in u)||!("y"in u))return;const p=i.symbol,y=function(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}(p),h=function(e){let t="",o="";if(e){const i=e.toLowerCase();-1!==i.indexOf("italic")?t="italic":-1!==i.indexOf("oblique")&&(t="oblique"),-1!==i.indexOf("bold")?o="bold":-1!==i.indexOf("light")&&(o="lighter")}return{style:t,weight:o}}(p.fontStyleName),g=U(p.fontFamilyName);p.font={family:g,decoration:y,...h};const d=e.frame,S=u.x-.5*(d.xmin+d.xmax),v=u.y-.5*(d.ymin+d.ymax),b=e.size/f,N=e.primitiveName,L=M(p.height)*b,I=M(p.angle),X=M(e.offsetX)+(M(p.offsetX)+S)*b,z=M(e.offsetY)+(M(p.offsetY)+v)*b,H=O(C.getFillColor(p));let J=O(C.getStrokeColor(p)),R=C.getStrokeWidth(p);R||(J=O(C.getFillColor(p.haloSymbol)),R=p.haloSize*b);const[A,Y]=Ne(n,N,t,o),F=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),E=m(JSON.stringify(i)+F+Y).toString();let $=ge(i.primitiveName,r,"TextString",a,i.textString,x,p.textCase);if(null==$)return;const{fontStyleName:T}=p,G=g+(T?"-"+T.toLowerCase():"-regular"),W=G;"string"==typeof $&&$.indexOf("[")>-1&&p.fieldMap&&($=P(p.fieldMap,$,p.textCase)),l.push({type:"text",templateHash:E,materialHash:A||"function"==typeof $||$.match(/\[(.*?)\]/)?(e,t,o)=>W+"-"+w($,e,t,o):W+"-"+m($),cim:p,materialOverrides:null,colorLocked:e.colorLocked,effects:t,alignment:s,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:G,decoration:y,weight:ge(N,r,"Weight",a,h.weight),style:ge(N,r,"Size",a,h.style),size:ge(N,r,"Size",a,L),angle:ge(N,r,"Rotation",a,I),offsetX:ge(N,r,"OffsetX",a,X),offsetY:ge(N,r,"OffsetY",a,z),horizontalAlignment:V(p.horizontalAlignment),verticalAlignment:_(p.verticalAlignment),text:$,color:H,outlineColor:J,outlineSize:R,referenceSize:c,sizeRatio:1,markerPlacement:o})}function ue(e,t,o,i,r,n,a,l,s,c,f,p,y){const h=i.symbol,g=h.symbolLayers;if(!g)return;if(y)return void pe(e,t,o,i,n,r,a,l,s,c,f,p);let d=g.length;if(ke(g))return void function(e,t,o,i,r,n,a,l,s,c,f,u){const p=i.geometry,y=r[0],h=r[1],g=F(p);if(!g)return;const[d,S,v]=E(g,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),b={type:"sdf",geom:p,asFill:!0},N=e.primitiveName,k=M(e.size),x=M(e.rotation),P=M(e.offsetX),w=M(e.offsetY),L=h.path,I=h.primitiveName,X=y.primitiveName,z=O(C.getFillColor(h)),H=O(C.getStrokeColor(y)),J=C.getStrokeWidth(y);let R=!1,A="";for(const e of n)e.primitiveName!==I&&e.primitiveName!==X&&e.primitiveName!==N||(void 0!==e.value?A+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(R=!0));const Y=JSON.stringify({...e,markerGraphics:null}),$=m(JSON.stringify(b)+L).toString(),T={type:"marker",templateHash:m(JSON.stringify(i)+JSON.stringify(h)+JSON.stringify(y)+Y+A).toString(),materialHash:R?()=>$:$,cim:b,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:c,anchorPoint:{x:S,y:v},isAbsoluteAnchorPoint:!1,size:ge(e.primitiveName,a,"Size",l,k),rotation:ge(e.primitiveName,a,"Rotation",l,x),offsetX:ge(e.primitiveName,a,"OffsetX",l,P),offsetY:ge(e.primitiveName,a,"OffsetY",l,w),scaleX:1,frameHeight:u,rotateClockwise:e.rotateClockwise,referenceSize:f,sizeRatio:d,color:ge(I,a,"Color",l,z,he),outlineColor:ge(X,a,"Color",l,H,he),outlineWidth:ge(X,a,"Width",l,J),markerPlacement:o,path:L};s.push(T)}(e,t,o,i,g,r,n,a,l,c,f,p);const S=G.applyEffects(h.effects,i.geometry,s.geometryEngine);if(S)for(;d--;){const y=g[d];if(y&&!1!==y.enable)switch(y.type){case"CIMSolidFill":case"CIMSolidStroke":{var v;const h=G.applyEffects(y.effects,S,s.geometryEngine),g=F(h);if(!g)continue;const[d,b,N]=E(g,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),k="CIMSolidFill"===y.type,x={type:"sdf",geom:h,asFill:k},P=e.primitiveName,w=null!=(v=M(e.size))?v:10,L=M(e.rotation),I=M(e.offsetX),X=M(e.offsetY),z=y.path,H=y.primitiveName,J=O(k?C.getFillColor(y):C.getStrokeColor(y)),R=k?{r:0,g:0,b:0,a:0}:O(C.getStrokeColor(y)),A=C.getStrokeWidth(y);if(!k&&!A)break;let Y=!1,$="";for(const e of r)e.primitiveName!==H&&e.primitiveName!==P||(void 0!==e.value?$+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(Y=!0));u(t)&&"function"==typeof t&&(Y=!0);const T=JSON.stringify({...e,markerGraphics:null}),W=m(JSON.stringify(x)+z).toString(),D={type:"marker",templateHash:m(JSON.stringify(i)+JSON.stringify(y)+T+$).toString(),materialHash:Y?()=>W:W,cim:x,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:c,anchorPoint:{x:b,y:N},isAbsoluteAnchorPoint:!1,size:ge(e.primitiveName,n,"Size",a,w),rotation:ge(e.primitiveName,n,"Rotation",a,L),offsetX:ge(e.primitiveName,n,"OffsetX",a,I),offsetY:ge(e.primitiveName,n,"OffsetY",a,X),scaleX:1,frameHeight:p,rotateClockwise:e.rotateClockwise,referenceSize:f,sizeRatio:d,color:ge(H,n,"Color",a,J,he),outlineColor:ge(H,n,"Color",a,R,he),outlineWidth:ge(H,n,"Width",a,A),markerPlacement:o,path:z};l.push(D);break}default:pe(e,t,o,i,n,r,a,l,s,c,f,p)}}}function pe(e,t,o,i,r,n,a,l,s,c,f,y){const h=function(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}(e,i);let g=[];const d=["Rotation","OffsetX","OffsetY"];g=n.filter((t=>t.primitiveName!==e.primitiveName||-1===d.indexOf(t.propertyName)));let S="";for(const e of n)void 0!==e.value&&(S+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`);const[v,b,N]=C.getTextureAnchor(h,s),k=e.primitiveName,O=M(e.rotation),x=M(e.offsetX),P=M(e.offsetY),w=m(JSON.stringify(h)+S).toString(),L={type:"marker",templateHash:w,materialHash:g.length>0||u(t)&&"function"==typeof t?ve(w,r,g,a):w,cim:h,materialOverrides:g,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:c,anchorPoint:{x:v,y:b},isAbsoluteAnchorPoint:!1,size:e.size,rotation:ge(k,r,"Rotation",a,O),offsetX:ge(k,r,"OffsetX",a,x),offsetY:ge(k,r,"OffsetY",a,P),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:y,rotateClockwise:e.rotateClockwise,referenceSize:f,sizeRatio:N/p(e.size),markerPlacement:o};l.push(L)}function ye(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function he(e){if(!e||0===e.length)return null;const t=new h(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function ge(e,t,o,i,r,n,a){const l=t[e];if(l){const e=l[o];if("string"==typeof e||"number"==typeof e||e instanceof Array)return n?n.call(null,e,a):e;if(null!=e&&e instanceof y)return(t,o,l)=>{let s=W(e,t,{$view:l},i.geometryType,o);return null!==s&&n&&(s=n.call(null,s,a)),null!==s?s:r}}return r}function de(e,t,o,i){for(const e of t)if(e.valueExpressionInfo){const t=o[e.primitiveName]&&o[e.primitiveName][e.propertyName];t instanceof y&&(e.fn=(e,o,r)=>W(t,e,{$view:r},i.geometryType,o))}const r=e=>e?e.charAt(0).toLowerCase()+e.substr(1):e;return(o,i,n)=>{for(const e of t)e.fn&&(e.value=e.fn(o,i,n));const a=[];for(let o of e){var l;const e=null==(l=o)?void 0:l.primitiveName;if(e){let i=!1;for(const n of t)if(n.primitiveName===e){const e=r(n.propertyName);null!=n.value&&n.value!==o[e]&&(i||(o=f(o),i=!0),o[e]=n.value)}}a.push(o)}return a}}function Se(e,t,o,i){const r=[];if(k.findApplicableOverrides(e,t,r),0===r.length)return e;for(const e of r)if(e.valueExpressionInfo){const t=o[e.primitiveName]&&o[e.primitiveName][e.propertyName];t instanceof y&&(e.fn=(e,o,r)=>W(t,e,{$view:r},i.geometryType,o))}const n=e=>e?e.charAt(0).toLowerCase()+e.substr(1):e;return(t,o,i)=>{for(const e of r)e.fn&&(e.value=e.fn(t,o,i));const a=f(e),l=e.primitiveName;for(const e of r)if(e.primitiveName===l){const t=n(e.propertyName);null!=e.value&&e.value!==a[t]&&(a[t]=e.value)}return a}}function ve(e,t,o,i){for(const e of o)if(e.valueExpressionInfo){const o=t[e.primitiveName]&&t[e.primitiveName][e.propertyName];o instanceof y&&(e.fn=(e,t,r)=>W(o,e,{$view:r},i.geometryType,t))}return(t,i,r)=>{for(const e of o)e.fn&&(e.value=e.fn(t,i,r));return m(e+k.buildOverrideKey(o)).toString()}}function be(e,t){if(!t||0===t.length)return e;const o=JSON.parse(JSON.stringify(e));return k.applyOverrides(o,t),o}function Ne(e,t,o,i){let r=!1,n="";for(const o of e)o.primitiveName===t&&(void 0!==o.value?n+=`-${o.primitiveName}-${o.propertyName}-${JSON.stringify(o.value)}`:o.valueExpressionInfo&&(r=!0));return u(o)&&"function"==typeof o&&(r=!0),u(i)&&"function"==typeof i&&(r=!0),[r,n]}function Ce(e,t,o){if(e&&t)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const i=e.symbolLayers;if(!i)return;for(const e of i)switch(Me(e,t,o),e.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in e&&e.url&&o.push(t.fetchResource(e.url,null));break;case"CIMVectorMarker":{const i=e.markerGraphics;if(!i)continue;for(const e of i)if(e){const i=e.symbol;i&&Ce(i,t,o)}}}}}}const ke=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&!e[0].effects&&!e[1].effects;let Oe;function Me(e,t,o){e.effects&&!u(t.geometryEngine)&&(Oe?o.push(Oe):L(e.effects)&&(Oe=I(),o.push(Oe),Oe.then((e=>t.geometryEngine=e))))}const xe={marker:J.MARKER,fill:J.FILL,line:J.LINE,text:J.TEXT};class Pe{constructor(e,t,o,i){const r={minScale:null==t?void 0:t.minScale,maxScale:null==t?void 0:t.maxScale},n=function(e){return e.minScale||e.maxScale?e.minScale+"-"+e.maxScale:""}(r);this.layers=e,this.data=t,this.hash=this._createHash()+n,this.rendererKey=o;const a={isOutline:!1,isOutlinedFill:!1,placement:null,stride:{fill:"default"},vvFlags:o};for(const t of e){const e=xe[t.type];t.materialKey=R(e,a),t.maxVVSize=i,t.scaleInfo=r,t.templateHash+=n}}get type(){return"expanded-cim"}_createHash(){let e="";for(const t of this.layers)e+=t.templateHash;return e}}export{ee as H,G as f,Pe as l,$ as m,j as n,be as o,A as r,W as s};
